<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VideoWall 控制台</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #111827, #0b1021 40%), linear-gradient(135deg, #1f2937, #0f172a);
      --card: rgba(255, 255, 255, 0.06);
      --card-border: rgba(255, 255, 255, 0.1);
      --text: #f8fafc;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-2: #a855f7;
      --success: #34d399;
      --danger: #f87171;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: "Segoe UI","Microsoft YaHei","PingFang SC",Arial,sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
    }
    h1 { margin: 0 0 12px; letter-spacing: 0.5px; }
    input, button, select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none; color: #0b1021; font-weight: 600; cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 6px 18px rgba(56,189,248,0.3);
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(56,189,248,0.35); }
    button.secondary { background: rgba(255,255,255,0.06); color: var(--text); box-shadow: none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: 14px; padding: 16px; backdrop-filter: blur(12px); box-shadow: var(--shadow); }
    .card h3 { margin: 0 0 10px; font-size: 16px; letter-spacing: 0.2px; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border-bottom: 1px solid var(--card-border); padding: 8px 6px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    .row { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); color: var(--muted); font-size: 12px; border: 1px solid var(--card-border); }
    #previewArea img { border-radius: 8px; border: 1px solid var(--card-border); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .preview-row { display:flex; gap:12px; align-items:center; flex-wrap:nowrap; }
    .preview-img.left, .preview-img.right { width:90px; height:160px; object-fit:cover; }
    .preview-img.center { width:320px; height:160px; object-fit:cover; }
    pre { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; color: #e5e7eb; overflow-x: auto; }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    nav.actions button.active { border: 1px solid var(--accent); }
    .thumb { width: 90px; height: 60px; object-fit: cover; border-radius: 6px; border:1px solid var(--card-border); }
    .slide-row { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--card-border); border-radius:10px; margin-bottom:8px; background:rgba(255,255,255,0.04); }
    .slide-row button { padding:4px 8px; }
    .preview-stage { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:12px; }
    .stage-box { background:#111; border:2px solid var(--card-border); border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
    .stage-box video, .stage-box img { width:100%; height:100%; object-fit:cover; }
    .ctrl-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <div>
      <h1>视频墙控制台</h1>
      <div class="pill">版本 v0.4.0 · 端口 8088 · WebSocket /ws</div>
    </div>
    <nav class="actions">
      <button class="secondary active" onclick="switchView('dashboard', this)">概览</button>
      <button class="secondary" onclick="switchView('devices', this)">设备</button>
      <button class="secondary" onclick="switchView('broadcast', this)">广播</button>
      <button class="secondary" onclick="switchView('upload', this)">上传/发布</button>
      <button class="secondary" onclick="switchView('programs', this)">节目库</button>
      <button class="secondary" onclick="switchView('schedule', this)">排程</button>
      <button class="secondary" onclick="switchView('power', this)">电源</button>
      <button class="secondary" onclick="switchView('settings', this)">设置</button>
    </nav>
  </header>

  <div id="dashboard" class="view">
    <div class="grid">
      <section class="card">
        <h3>实时设备</h3>
        <table id="deviceTable">
          <thead><tr><th>ID</th><th>角色</th><th>IP</th><th>状态</th><th>最近时间</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="actions" style="margin-top:8px;">
          <button class="secondary" onclick="loadDevices()">刷新设备</button>
        </div>
      </section>
      <section class="card stack">
        <h3>快速广播</h3>
        <div class="row">左 URL：<input id="urlLeft" size="48" placeholder="http://example/left.mp4"></div>
        <div class="row">中 URL：<input id="urlCenter" size="48" placeholder="http://example/center.mp4"></div>
        <div class="row">右 URL：<input id="urlRight" size="48" placeholder="http://example/right.mp4"></div>
        <div class="row">延时(秒)：<input id="delay" type="number" value="5" min="0" style="width:80px"> 节目ID：<input id="programId" value="manual"></div>
        <div class="actions">
          <button onclick="sendPlay()">广播并同步</button>
          <button class="secondary" onclick="sendStop()">停止</button>
        </div>
      </section>
    </div>
  </div>

  <div id="devices" class="view" style="display:none;">
    <section class="card">
      <h3>连接设备</h3>
      <table id="deviceTable2">
        <thead><tr><th>ID</th><th>角色</th><th>IP</th><th>状态</th><th>最近时间</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="actions" style="margin-top:8px;">
        <button onclick="loadDevices(true)">刷新设备</button>
      </div>
    </section>
  </div>

  <div id="broadcast" class="view" style="display:none;">
    <section class="card stack">
      <h3>手动广播</h3>
      <div class="row">左 URL：<input id="urlLeft2" size="60" placeholder="http://example/left.mp4"></div>
      <div class="row">中 URL：<input id="urlCenter2" size="60" placeholder="http://example/center.mp4"></div>
      <div class="row">右 URL：<input id="urlRight2" size="60" placeholder="http://example/right.mp4"></div>
      <div class="row">延时(秒)：<input id="delay2" type="number" value="5" min="0" style="width:80px"> 节目ID：<input id="programId2" value="manual"></div>
      <div class="actions">
        <button onclick="sendPlay(true)">广播并同步</button>
        <button class="secondary" onclick="sendStop()">停止</button>
      </div>
    </section>
  </div>

  <div id="upload" class="view" style="display:none;">
    <section class="card stack">
      <h3>节目制作（裁切 & 缝隙校准 & 预览）</h3>
      <div class="row">
        适配方式：
        <select id="mode">
          <option value="cover">裁剪填满（默认）</option>
          <option value="contain">等比缩放居中留黑边</option>
          <option value="stretch">拉伸铺满</option>
        </select>
      </div>
      <div class="row">屏间缝隙 (像素)：Gap1 <input id="gap1" type="number" value="0" min="0" style="width:80px" oninput="updateGapPreview()"> Gap2 <input id="gap2" type="number" value="0" min="0" style="width:80px" oninput="updateGapPreview()"></div>
      <div class="row">可视化示意：五段（左屏 | 缝1 | 中屏 | 缝2 | 右屏），帮助对齐实体边框。</div>
      <div class="card" style="background:rgba(255,255,255,0.04);">
        <div id="gapViz" style="display:flex;align-items:center;gap:4px;height:70px;"></div>
        <div id="gapLabel" style="color:var(--muted);font-size:12px;margin-top:6px;"></div>
      </div>
      <input type="file" id="uploadFile">
      <div class="actions">
        <button onclick="doUpload()">上传并生成节目</button>
        <span id="uploadStatus"></span>
      </div>
      <div id="previewArea" style="display:none;">
        <div class="row">预览（左 / 中 / 右）</div>
        <div class="preview-row">
          <img id="prevLeft" class="preview-img left" alt="左屏预览">
          <img id="prevCenter" class="preview-img center" alt="中屏预览">
          <img id="prevRight" class="preview-img right" alt="右屏预览">
        </div>
        <div class="actions" style="margin-top:8px;">
          <button onclick="confirmBroadcast()">确认发布并播放</button>
        </div>
      </div>
    </section>

    <section class="card stack">
      <h3>节目时间线编辑</h3>
      <div class="row">
        节目名称：<input id="timelineName" placeholder="my_show_001" style="min-width:180px">
        默认图片停留(秒)：<input id="defaultImageDur" type="number" value="5" min="1" style="width:80px">
        默认转场：<select id="defaultEffect">
          <option value="random">随机</option>
          <option value="fade">淡入淡出</option>
          <option value="slide">滑动</option>
          <option value="zoom">缩放</option>
          <option value="push">推拉</option>
          <option value="wipe">百叶</option>
        </select>
        <button class="secondary" onclick="applyDefaults()">应用到全部图片</button>
      </div>
      <div class="row">素材列表（可拖动排序，点击缩略图可预览/调整）：</div>
      <div id="slidesList"></div>
      <div class="actions">
        <button onclick="previewTimeline()">预览整节目的三屏效果</button>
        <button class="secondary" onclick="saveTimeline()">保存为节目</button>
        <span id="timelineStatus"></span>
      </div>
    </section>

    <section class="card stack" id="timelinePreviewPanel" style="display:none;">
      <h3>节目预览</h3>
      <div class="preview-stage">
        <div class="stage-box" style="width:120px;height:200px;"><video id="stageLeft" muted></video><img id="stageLeftImg" style="display:none;"></div>
        <div class="stage-box" style="width:380px;height:200px;"><video id="stageCenter" muted></video><img id="stageCenterImg" style="display:none;"></div>
        <div class="stage-box" style="width:120px;height:200px;"><video id="stageRight" muted></video><img id="stageRightImg" style="display:none;"></div>
      </div>
      <div class="ctrl-bar">
        <button onclick="prevSlide()">上一个</button>
        <button onclick="togglePlay()" id="btnPlay">播放</button>
        <button onclick="nextSlide()">下一个</button>
        <button class="secondary" onclick="stopPreview()">关闭预览</button>
        <span id="previewLabel" style="color:var(--muted);"></span>
      </div>
    </section>
  </div>

  <div id="programs" class="view" style="display:none;">
    <section class="card">
      <h3>节目列表</h3>
      <div class="row">
        <input id="customTitle" placeholder="节目标题" style="flex:1;min-width:160px">
        <button class="secondary" onclick="saveCustom()">保存当前三屏为节目</button>
        <button class="secondary" onclick="refreshFromDisk()">重新读取节目目录</button>
      </div>
      <table id="programTable">
        <thead><tr><th>ID</th><th>标题</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <div id="schedule" class="view" style="display:none;">
    <section class="card">
      <h3>排程</h3>
      <div class="row">节目ID：<input id="schedProgramId" placeholder="program id"> 开始UTC毫秒：<input id="schedStart" size="20" placeholder="Date.now()+10000"></div>
      <div class="actions">
        <button onclick="addSchedule()">添加排程</button>
        <button class="secondary" onclick="loadSchedule()">刷新排程</button>
      </div>
      <table id="scheduleTable">
        <thead><tr><th>ID</th><th>节目</th><th>开始</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <div id="power" class="view" style="display:none;">
    <section class="card">
      <h3>电源控制</h3>
      <div class="actions">
        <button onclick="power('sleep')">熄屏/暂停</button>
        <button class="secondary" onclick="power('wake')">唤醒</button>
        <button class="secondary" onclick="power('reboot')">重启</button>
      </div>
    </section>
  </div>

  <div id="settings" class="view" style="display:none;">
    <section class="card">
      <h3>客户端 IP 配置</h3>
      <div class="row">左屏 IP：<input id="ipLeft" size="18" placeholder="192.168.x.x"></div>
      <div class="row">中屏 IP：<input id="ipCenter" size="18" placeholder="192.168.x.x"></div>
      <div class="row">右屏 IP：<input id="ipRight" size="18" placeholder="192.168.x.x"></div>
      <div class="actions">
        <button onclick="saveClientIps()">保存</button>
        <span id="ipSaveStatus" style="color:var(--success);"></span>
      </div>
    </section>
  </div>

  <pre id="log"></pre>

<script>
function switchView(id, btn) {
  document.querySelectorAll(".view").forEach(v => v.style.display = v.id === id ? "block" : "none");
  document.querySelectorAll("nav.actions button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
  if (id === "devices") loadDevices(true);
  if (id === "programs") loadPrograms();
  if (id === "schedule") loadSchedule();
}

async function safeFetch(url, opts = {}) {
  try {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res;
  } catch (e) {
    log("请求失败: " + e.message);
    return null;
  }
}

function renderDevices(selector, list = []) {
  const tbody = document.querySelector(selector);
  if (!tbody) return;
  tbody.innerHTML = "";
  list.forEach((d) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.id}</td><td>${d.role}</td><td>${d.ip || ""}</td><td>${d.online ? "在线" : "离线"}</td><td>${new Date(d.lastSeen || 0).toLocaleTimeString()}</td>`;
    tbody.appendChild(tr);
  });
}

// --- 时间线/节目制作状态 ---
let slides = []; // {type:image|video, urlLeft,urlCenter,urlRight,preview,title,effect,duration}
let timelinePlaying = false;
let timelineIndex = 0;
let timelineTimer = null;

function renderSlidesList() {
  const wrap = document.querySelector("#slidesList");
  if (!wrap) return;
  wrap.innerHTML = "";
  slides.forEach((s, idx) => {
    const row = document.createElement("div");
    row.className = "slide-row";
    const thumb = document.createElement("img");
    thumb.src = s.preview || s.urlCenter || "";
    thumb.className = "thumb";
    thumb.onclick = () => editSlide(idx);
    row.appendChild(thumb);
    const info = document.createElement("div");
    info.style.flex = "1";
    info.innerHTML = `<div>#${idx + 1} ${s.type.toUpperCase()} ${s.title || ""}</div>
      <div style="font-size:12px;color:var(--muted);">转场: ${s.effect || "random"} · 图片停留: ${s.duration || "-"}s</div>`;
    row.appendChild(info);
    const btns = document.createElement("div");
    btns.style.display = "flex";
    btns.style.gap = "6px";
    ["↑","↓","删"].forEach((txt,i)=>{
      const b=document.createElement("button"); b.textContent=txt;
      b.onclick=()=>{ if(i===0) moveSlide(idx,-1); else if(i===1) moveSlide(idx,1); else deleteSlide(idx); };
      btns.appendChild(b);
    });
    row.appendChild(btns);
    wrap.appendChild(row);
  });
  if (!slides.length) {
    const tip = document.createElement("div");
    tip.style.color = "var(--muted)";
    tip.textContent = "暂无素材，先上传或添加节目切片。";
    wrap.appendChild(tip);
  }
}

function moveSlide(idx, delta) {
  const n = idx + delta;
  if (n < 0 || n >= slides.length) return;
  [slides[idx], slides[n]] = [slides[n], slides[idx]];
  renderSlidesList();
}
function deleteSlide(idx) { slides.splice(idx,1); renderSlidesList(); }
function editSlide(idx) {
  const s = slides[idx];
  const dur = prompt("图片停留时间(秒)，视频忽略", s.duration || 5);
  if (dur !== null && !isNaN(Number(dur))) s.duration = Number(dur);
  const eff = prompt("转场效果（random/fade/slide/zoom/push/wipe）", s.effect || "random");
  if (eff) s.effect = eff;
  renderSlidesList();
}
function applyDefaults() {
  const dur = Number(document.querySelector("#defaultImageDur").value || 5);
  const eff = document.querySelector("#defaultEffect").value || "random";
  slides = slides.map(s => {
    if (s.type === "image") s.duration = dur;
    if (!s.effect || s.effect === "random") s.effect = eff;
    return s;
  });
  renderSlidesList();
}

function setStageMedia(videoEl, imgEl, url) {
  if (!url) { videoEl.style.display="none"; imgEl.style.display="none"; return; }
  const isVid = url.toLowerCase().match(/\\.mp4|\\.mov|\\.webm/);
  if (isVid) {
    videoEl.src = url; videoEl.style.display="block"; imgEl.style.display="none"; videoEl.currentTime=0; videoEl.play();
  } else {
    imgEl.src = url; imgEl.style.display="block"; videoEl.style.display="none"; videoEl.pause();
  }
}
function playSlide(idx) {
  clearTimeout(timelineTimer);
  const s = slides[idx];
  document.querySelector("#previewLabel").textContent = `第 ${idx+1}/${slides.length} · ${s.title||""} · 转场 ${s.effect||"random"}`;
  setStageMedia(stageLeft, stageLeftImg, s.urlLeft);
  setStageMedia(stageCenter, stageCenterImg, s.urlCenter);
  setStageMedia(stageRight, stageRightImg, s.urlRight);
  if (!timelinePlaying) return;
  const durMs = s.type === "image" ? (s.duration || Number(document.querySelector("#defaultImageDur").value || 5))*1000 : 5000;
  timelineTimer = setTimeout(()=>{ timelineIndex = (timelineIndex+1)%slides.length; playSlide(timelineIndex); }, durMs);
}
function previewTimeline() {
  if (!slides.length) { alert("先添加素材"); return; }
  timelinePlaying = true; timelineIndex = 0;
  document.querySelector("#timelinePreviewPanel").style.display="block";
  document.querySelector("#btnPlay").textContent="暂停";
  playSlide(timelineIndex);
}
function stopPreview() { timelinePlaying=false; clearTimeout(timelineTimer); document.querySelector("#timelinePreviewPanel").style.display="none"; }
function togglePlay(){ timelinePlaying=!timelinePlaying; document.querySelector("#btnPlay").textContent= timelinePlaying? "暂停":"播放"; if(timelinePlaying) playSlide(timelineIndex);}
function prevSlide(){ if(!slides.length)return; timelineIndex=(timelineIndex-1+slides.length)%slides.length; playSlide(timelineIndex);}
function nextSlide(){ if(!slides.length)return; timelineIndex=(timelineIndex+1)%slides.length; playSlide(timelineIndex);}

async function saveTimeline() {
  if (!slides.length) { alert("先添加素材"); return; }
  const name = document.querySelector("#timelineName").value || `program_${Date.now()}`;
  const first = slides[0];
  const slices = {
    left: { url: first.urlLeft, effect: first.effect || "random", audio: false },
    center: { url: first.urlCenter, effect: first.effect || "random", audio: true },
    right: { url: first.urlRight, effect: first.effect || "random", audio: false }
  };
  const body = { id: name, title: name, slices, sequence: slides };
  const res = await safeFetch("/api/programs/custom", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  document.querySelector("#timelineStatus").textContent = data.ok ? "已保存节目" : (data.error || "失败");
  loadPrograms();
  setTimeout(()=>document.querySelector("#timelineStatus").textContent="",2000);
}
async function loadDevices(refreshOnly = false) {
  const res = await safeFetch("/api/devices");
  if (!res) return;
  const data = await res.json();
  renderDevices("#deviceTable tbody", data.devices);
  renderDevices("#deviceTable2 tbody", data.devices);
  if (!refreshOnly) log(`设备数：${(data.devices || []).length}`);
}

async function sendPlay(useAlt = false) {
  const delay = Number(document.querySelector(useAlt ? "#delay2" : "#delay").value || 0);
  const body = {
    programId: document.querySelector(useAlt ? "#programId2" : "#programId").value || "manual",
    startAtUtcMs: Date.now() + delay * 1000,
    loop: true,
    screens: {
      left: { url: document.querySelector(useAlt ? "#urlLeft2" : "#urlLeft").value, effect: "fade", audio: false },
      center: { url: document.querySelector(useAlt ? "#urlCenter2" : "#urlCenter").value, effect: "fade", audio: true },
      right: { url: document.querySelector(useAlt ? "#urlRight2" : "#urlRight").value, effect: "fade", audio: false },
    },
  };
  const res = await safeFetch("/api/broadcast", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  log(JSON.stringify(data, null, 2));
}

async function sendStop() {
  const res = await safeFetch("/api/stop", { method: "POST" });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function power(action) {
  const res = await safeFetch("/api/power", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function doUpload() {
  const fileInput = document.querySelector("#uploadFile");
  if (!fileInput.files.length) {
    alert("请选择文件");
    return;
  }
  const form = new FormData();
  form.append("file", fileInput.files[0]);
  form.append("mode", document.querySelector("#mode").value);
  form.append("gap1", document.querySelector("#gap1").value || "0");
  form.append("gap2", document.querySelector("#gap2").value || "0");
  document.querySelector("#uploadStatus").textContent = "上传中...";
  document.querySelector("#previewArea").style.display = "none";
  const res = await safeFetch("/api/upload", { method: "POST", body: form });
  if (!res) return;
  const data = await res.json();
  if (data.ok) {
    const p = data.program;
    document.querySelector("#uploadStatus").textContent = `生成节目 ${p.id}`;
    document.querySelector("#previewArea").style.display = "block";
    document.querySelector("#prevLeft").src = p.slices.left.preview;
    document.querySelector("#prevCenter").src = p.slices.center.preview;
    document.querySelector("#prevRight").src = p.slices.right.preview;
    window.__lastProgramId = p.id;
    loadPrograms();
  } else {
    document.querySelector("#uploadStatus").textContent = `失败: ${data.error}`;
  }
}

async function confirmBroadcast() {
  const pid = window.__lastProgramId;
  if (!pid) {
    alert("没有可发布的节目");
    return;
  }
  const res = await safeFetch(`/api/programs/${pid}/broadcast`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ startAtUtcMs: Date.now() + 5000 }) });
  if (!res) return;
  const data = await res.json();
  log(JSON.stringify(data, null, 2));
}

async function loadPrograms() {
  const res = await safeFetch("/api/programs");
  if (!res) return;
  const data = await res.json();
  const tbody = document.querySelector("#programTable tbody");
  tbody.innerHTML = "";
  (data.programs || []).forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.id}</td><td>${p.title || ""}</td><td>${new Date(p.createdAt).toLocaleString()}</td>
    <td><button onclick="broadcastProgram('${p.id}')">播放</button></td>`;
    tbody.appendChild(tr);
  });
}

async function broadcastProgram(id) {
  const res = await safeFetch(`/api/programs/${id}/broadcast`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ startAtUtcMs: Date.now() + 5000 }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function saveCustom() {
  const title = document.querySelector("#customTitle").value || "custom";
  const id = title.toLowerCase().replace(/[^a-z0-9]+/g, "_") + "_" + Date.now();
  const slices = {
    left: { url: document.querySelector("#urlLeft").value, effect: "random", audio: false },
    center: { url: document.querySelector("#urlCenter").value, effect: "random", audio: true },
    right: { url: document.querySelector("#urlRight").value, effect: "random", audio: false },
  };
  const res = await safeFetch("/api/programs/custom", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, title, slices }) });
  if (!res) return;
  const data = await res.json();
  if (data.ok) {
    loadPrograms();
    log(`已保存节目 ${id}`);
  } else {
    log(`保存失败: ${data.error}`);
  }
}

async function refreshFromDisk() {
  const res = await safeFetch("/api/programs/reload", { method: "POST" });
  if (!res) return;
  const data = await res.json();
  if (data.ok) {
    loadPrograms();
    log(`已从磁盘刷新，当前节目数 ${data.count}`);
  } else {
    log(`刷新失败: ${data.error}`);
  }
}

async function addSchedule() {
  const programId = document.querySelector("#schedProgramId").value;
  const startAtUtcMs = Number(document.querySelector("#schedStart").value);
  const res = await safeFetch("/api/schedule", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ programId, startAtUtcMs }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
  loadSchedule();
}

async function loadSchedule() {
  const res = await safeFetch("/api/schedule");
  if (!res) return;
  const data = await res.json();
  const tbody = document.querySelector("#scheduleTable tbody");
  tbody.innerHTML = "";
  (data.schedules || []).forEach((s) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.id}</td><td>${s.programId}</td><td>${new Date(s.startAtUtcMs).toLocaleString()}</td>
    <td><button onclick="deleteSchedule('${s.id}')">删除</button></td>`;
    tbody.appendChild(tr);
  });
}

async function deleteSchedule(id) {
  const res = await safeFetch(`/api/schedule/${id}`, { method: "DELETE" });
  if (!res) return;
  loadSchedule();
}

function log(msg) { document.querySelector("#log").textContent = msg; }

async function loadClientIps() {
  const res = await safeFetch("/api/client-ips");
  if (!res) return;
  const data = await res.json();
  const ips = data.clientIps || {};
  document.querySelector("#ipLeft").value = ips.left || "";
  document.querySelector("#ipCenter").value = ips.center || "";
  document.querySelector("#ipRight").value = ips.right || "";
}

async function saveClientIps() {
  const body = {
    left: document.querySelector("#ipLeft").value,
    center: document.querySelector("#ipCenter").value,
    right: document.querySelector("#ipRight").value,
  };
  const res = await safeFetch("/api/client-ips", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  document.querySelector("#ipSaveStatus").textContent = data.ok ? "已保存" : (data.error || "失败");
  setTimeout(() => (document.querySelector("#ipSaveStatus").textContent = ""), 2000);
}

// 初始加载
loadDevices();
loadPrograms();
loadSchedule();
loadClientIps();
updateGapPreview();

function updateGapPreview() {
  const gap1 = Number(document.querySelector("#gap1").value || 0);
  const gap2 = Number(document.querySelector("#gap2").value || 0);
  const total = 1080 + gap1 + 3840 + gap2 + 1080;
  const scale = 600 / total;
  const segs = [
    { w: 1080, color: "#38bdf8", label: "左屏" },
    { w: gap1, color: "#f59e0b", label: `缝1 ${gap1}px` },
    { w: 3840, color: "#22c55e", label: "中屏" },
    { w: gap2, color: "#f59e0b", label: `缝2 ${gap2}px` },
    { w: 1080, color: "#38bdf8", label: "右屏" },
  ];
  const viz = document.querySelector("#gapViz");
  viz.innerHTML = "";
  segs.forEach((s) => {
    const div = document.createElement("div");
    div.style.width = `${Math.max(s.w * scale, 2)}px`;
    div.style.height = "40px";
    div.style.background = s.color;
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.justifyContent = "center";
    div.style.fontSize = "11px";
    div.style.color = "#0b1021";
    div.textContent = s.label;
    viz.appendChild(div);
  });
  document.querySelector("#gapLabel").textContent = `总宽 ${total}px，缩放预览 600px；缝隙将被“压缩”掉，避免实际拼缝的黑边。`;
}
</script>
</body>
</html>
