<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>VideoWall 控制台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    input, button { padding: 6px; margin: 4px 0; }
    .row { margin-bottom: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>视频墙控制台 (MVP)</h1>

  <section>
    <h3>在线设备</h3>
    <button onclick="loadDevices()">刷新列表</button>
    <table id="deviceTable">
      <thead><tr><th>ID</th><th>角色</th><th>状态</th><th>最近心跳</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h3>下发播放</h3>
    <div class="row">左屏 URL：<input id="urlLeft" size="60" placeholder="http://example/left.mp4"></div>
    <div class="row">中屏 URL：<input id="urlCenter" size="60" placeholder="http://example/center.mp4"></div>
    <div class="row">右屏 URL：<input id="urlRight" size="60" placeholder="http://example/right.mp4"></div>
    <div class="row">延迟 (秒)：<input id="delay" type="number" value="5" min="0" style="width:80px"> 程序ID：<input id="programId" value="demo1"></div>
    <button onclick="sendPlay()">下发并同步播放</button>
    <button onclick="sendStop()">停止</button>
  </section>

  <section>
    <h3>电源控制</h3>
    <button onclick="power('sleep')">息屏/待机</button>
    <button onclick="power('wake')">唤醒</button>
    <button onclick="power('reboot')">重启</button>
  </section>

  <pre id="log"></pre>

<script>
async function loadDevices() {
  const res = await fetch('/api/devices');
  const data = await res.json();
  const tbody = document.querySelector('#deviceTable tbody');
  tbody.innerHTML = '';
  data.devices.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.id}</td><td>${d.role}</td><td>${d.online?'在线':'离线'}</td><td>${new Date(d.lastSeen||0).toLocaleTimeString()}</td>`;
    tbody.appendChild(tr);
  });
}

async function sendPlay() {
  const delay = Number(document.querySelector('#delay').value || 0);
  const body = {
    programId: document.querySelector('#programId').value || 'demo',
    startAtUtcMs: Date.now() + delay * 1000,
    loop: true,
    screens: {
      left:   { url: document.querySelector('#urlLeft').value, effect: 'fade', audio: false },
      center: { url: document.querySelector('#urlCenter').value, effect: 'fade', audio: true },
      right:  { url: document.querySelector('#urlRight').value, effect: 'fade', audio: false }
    }
  };
  const res = await fetch('/api/broadcast', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const data = await res.json();
  log(JSON.stringify(data,null,2));
}

async function sendStop() {
  const res = await fetch('/api/stop', { method:'POST' });
  log(JSON.stringify(await res.json(), null, 2));
}

async function power(action){
  const res = await fetch('/api/power', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action})});
  log(JSON.stringify(await res.json(), null, 2));
}

function log(msg){
  document.querySelector('#log').textContent = msg;
}

loadDevices();
</script>
</body>
</html>
