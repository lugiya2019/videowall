<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VideoWall 控制台 v0.8.0</title>
  <style>
    :root {
      --bg: #0d1526;
      --panel: #111c30;
      --panel-2: #16243a;
      --card: rgba(255, 255, 255, 0.04);
      --card-border: rgba(255, 255, 255, 0.08);
      --text: #e8edf7;
      --muted: #97a9c7;
      --accent: #22d3ee;
      --accent-2: #a855f7;
      --success: #22c55e;
      --danger: #f97316;
      --shadow: 0 14px 36px rgba(0, 0, 0, 0.45);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI","Microsoft YaHei","PingFang SC",Arial,sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      display: flex;
    }
    h1 { margin: 0 0 12px; letter-spacing: 0.5px; }
    input, button, select { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--card-border); background: rgba(255,255,255,0.05); color: var(--text); outline: none; }
    input:focus, select:focus { border-color: var(--accent); }
    select option { background:#0b1021; color: var(--text); }
    button { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; color: #0b1021; font-weight: 600; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; box-shadow: 0 6px 18px rgba(56,189,248,0.3);}
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(56,189,248,0.35);}
    button.secondary { background: rgba(255,255,255,0.06); color: var(--text); box-shadow: none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: 14px; padding: 16px; backdrop-filter: blur(12px); box-shadow: var(--shadow); }
    .card h3 { margin: 0 0 10px; font-size: 16px; letter-spacing: 0.2px; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border-bottom: 1px solid var(--card-border); padding: 8px 6px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    .row { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); color: var(--muted); font-size: 12px; border: 1px solid var(--card-border); }
    .badge { padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.08); font-size:12px; color:var(--muted);}
    #previewArea img { border-radius: 8px; border: 1px solid var(--card-border); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    pre { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; color: #e5e7eb; overflow-x: auto; }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    nav.actions button.active { border: 1px solid var(--accent); }
    .thumb { width: 90px; height: 60px; object-fit: cover; border-radius: 6px; border:1px solid var(--card-border); }
    .slide-row { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--card-border); border-radius:10px; margin-bottom:8px; background:rgba(255,255,255,0.04); }
    .slide-row button { padding:4px 8px; }
    .row-selected { background: rgba(56,189,248,0.15) !important; border-color: var(--accent) !important; }
    .preview-row { display:flex; gap:12px; align-items:center; }
    .preview-img.left, .preview-img.right { width:90px; height:160px; object-fit:cover; }
    .preview-img.center { width:320px; height:160px; object-fit:cover; }
    .preview-stage { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:12px; }
    .stage-box { background:#111; border:2px solid var(--card-border); border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
    .stage-box video, .stage-box img { width:100%; height:100%; object-fit:cover; transition: opacity 0.3s ease, transform 0.3s ease; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal .panel { background:var(--card); border:1px solid var(--card-border); border-radius:14px; padding:16px; width:880px; max-width:95vw; box-shadow:var(--shadow); }
    .modal .panel h4 { margin:0 0 10px; }
    .range-row { display:flex; align-items:center; gap:8px; margin:6px 0; flex-wrap:wrap; }
    .ctrl-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }

    /* Shell layout */
    .app-shell { display:flex; width:100%; }
    .sidebar {
      width: 230px;
      background: linear-gradient(180deg, #0f1b2f, #0d1729);
      border-right: 1px solid rgba(255,255,255,0.04);
      box-shadow: inset -1px 0 0 rgba(255,255,255,0.04);
      padding: 18px 14px;
      display:flex; flex-direction:column; gap:14px;
      position: fixed; inset:0 auto 0 0;
      z-index: 15;
      overflow:hidden;
      transform: translateX(0);
      transition: transform 0.22s ease;
      will-change: transform;
    }
    .sidebar-toggle {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      left: 230px;
      height: 96px;
      min-width: 12px;
      width: 18px;
      padding: 0 4px;
      display:flex; align-items:center; justify-content:center;
      background: transparent;
      color: var(--text);
      border: 1px solid transparent;
      border-left: none; /* 贴合侧边栏不留缝 */
      border-radius: 0 9px 9px 0;
      box-shadow: none;
      cursor: pointer;
      overflow: hidden;
      z-index: 30;
      opacity: 1;
      transition: left 0.22s ease, width 0.18s ease, background 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }
    .sidebar-toggle:hover,
    .sidebar-toggle:focus-visible {
      width: 24px;
      background: rgba(255,255,255,0.08);
      box-shadow: 0 8px 18px rgba(0,0,0,0.34);
      border-color: rgba(255,255,255,0.18);
      outline: none;
      transform: translateY(-50%);
    }
    .sidebar-toggle .toggle-icon { display:grid; place-items:center; font-size:16px; width:18px; height:18px; flex-shrink:0; }
    .sidebar-toggle .toggle-icon svg { width:18px; height:18px; transition: transform 0.18s ease; }
    body.sidebar-collapsed .sidebar-toggle { left: 0; border-left: 1px solid var(--card-border); }
    .main-content { flex:1; margin-left:230px; padding:24px 28px 48px; transition: margin-left 0.22s ease; }
    .brand { display:flex; align-items:center; gap:10px; padding:6px 8px; }
    .brand-logo {
      width:38px; height:38px; border-radius:10px;
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      display:flex; align-items:center; justify-content:center;
      color:#0b1220; font-weight:800; letter-spacing:0.5px;
    }
    .brand-text { line-height:1.3; }
    .brand-text .name { font-weight:700; }
    .brand-text .desc { color: var(--muted); font-size:12px; }
    .collapse-btn { display:none; }
    .main-nav { display:flex; flex-direction:column; gap:6px; }
    .nav-btn {
      width:100%; display:flex; align-items:center; gap:12px;
      padding:10px 12px; border-radius:10px;
      background: transparent; border:1px solid transparent;
      color: var(--text); cursor:pointer; transition: all 0.15s ease;
      text-align:left; font-weight:600; letter-spacing:0.2px;
      white-space:nowrap; overflow:hidden;
    }
    .nav-btn svg { width:18px; height:18px; stroke:#ffffff; fill:none; stroke-width:2; opacity:0.9; }
    .nav-btn .nav-label { display:inline-block; transition: opacity 0.15s ease; }
    .nav-btn:hover { background: rgba(255,255,255,0.05); }
    .nav-btn:hover svg { opacity:1; }
    .nav-btn.active { background: rgba(34,211,238,0.14); border-color: rgba(168,85,247,0.35); box-shadow: 0 8px 20px rgba(0,0,0,0.28); }
    .nav-btn.active svg { opacity:1; }
    .side-footer { margin-top:auto; padding:12px 8px 8px; }
    .mode-switch { display:flex; gap:8px; background:rgba(255,255,255,0.04); border:1px solid var(--card-border); border-radius:12px; padding:6px; }
    .mode-btn {
      flex:1; padding:10px 8px; border-radius:9px;
      background:transparent; border:1px solid transparent;
      color:var(--text); cursor:pointer; font-weight:600;
      transition: all 0.12s ease;
    }
    .mode-btn.active { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1220; box-shadow:0 8px 18px rgba(168,85,247,0.35); }
    .mode-btn:not(.active):hover { border-color: var(--card-border); background:rgba(255,255,255,0.05); }
    .version-text { margin-top:8px; text-align:center; color:var(--muted); font-size:12px; }

    /* Top bar */
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .topbar-title { font-size:18px; font-weight:800; letter-spacing:0.4px; margin-top:-20px; }
    .user-chip { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.06); border:1px solid var(--card-border); }
    .dot-online { width:8px; height:8px; border-radius:50%; background:var(--success); box-shadow:0 0 0 4px rgba(34,197,94,0.15); }

    /* Dashboard */
    .dashboard-view { display:flex; flex-direction:column; gap:14px; }
    .stat-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
    .stat-card { background: var(--panel); border:1px solid var(--card-border); border-radius: var(--radius); padding:14px; display:flex; align-items:center; gap:12px; box-shadow: var(--shadow); }
    .stat-icon { width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; color:#0c1324; background: linear-gradient(135deg, #3b82f6, #60a5fa); }
    .stat-icon img { width:28px; height:28px; object-fit:contain; }
    .stat-meta { color: var(--muted); font-size:12px; }
    .stat-value { font-size:26px; font-weight:800; letter-spacing:0.6px; }
    .panel-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:12px; }
    .panel-title { font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .card { background: var(--panel-2); border: 1px solid var(--card-border); border-radius: var(--radius); padding: 16px; backdrop-filter: blur(8px); box-shadow: var(--shadow); }
    .ring-wrap { position:relative; display:flex; align-items:center; justify-content:center; height:220px; }
    .ring-center { position:absolute; text-align:center; }
    .ring-center .big { font-size:28px; font-weight:800; }
    .legend { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; color:var(--muted); font-size:13px; }
    .legend li { display:flex; align-items:center; gap:8px; }
    .legend .swatch { width:10px; height:10px; border-radius:50%; }
    .bar-chart { display:flex; flex-direction:column; gap:8px; }
    .bar-row { display:flex; align-items:center; gap:8px; }
    .bar-row .bar { flex:1; height:10px; border-radius:6px; background:rgba(255,255,255,0.08); overflow:hidden; }
    .bar-row .fill { height:100%; border-radius:6px; background:linear-gradient(90deg, #3b82f6, #60a5fa); }
    .event-list { display:flex; flex-direction:column; gap:10px; max-height:260px; overflow:auto; }
    .event-item { padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid var(--card-border); }
    .event-item .time { color:var(--muted); font-size:12px; }
    .muted-text { color:var(--muted); }

    /* Collapse states */
    body.sidebar-collapsed .sidebar { transform: translateX(-100%); padding:18px 14px; border:none; box-shadow:none; }
    body.sidebar-collapsed .main-content { margin-left:0; }
    /* 收起时只滑出屏幕，内部元素保持原位，避免位移动画 */

    /* Animate sidebar using transform */
    body:not(.sidebar-collapsed) .sidebar { transform: translateX(0); }

    @keyframes fadeIn { from { opacity:0;} to {opacity:1;} }
    @keyframes slideIn { from { transform: translateX(40px); opacity:0;} to {transform: translateX(0); opacity:1;} }
    @keyframes zoomIn { from { transform: scale(0.9); opacity:0;} to {transform: scale(1); opacity:1;} }
    @keyframes pushIn { from { transform: translateX(-50px); opacity:0.4;} to {transform: translateX(0); opacity:1;} }
    @keyframes wipeIn { from { clip-path: inset(0 100% 0 0); } to { clip-path: inset(0 0 0 0);} }
    .anim-fade { animation: fadeIn 0.35s ease; }
    .anim-slide { animation: slideIn 0.35s ease; }
    .anim-zoom { animation: zoomIn 0.35s ease; }
    .anim-push { animation: pushIn 0.4s ease; }
    .anim-wipe { animation: wipeIn 0.45s ease; }
    /* 赏析弹窗与元信息 */
    .analysis-panel { width:min(1200px,96vw); }
    .analysis-body { display:flex; gap:14px; align-items:flex-start; min-height:320px; }
    .analysis-left { flex:0 0 44%; background:rgba(255,255,255,0.03); border:1px solid var(--card-border); border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:center; }
    .analysis-left img, .analysis-left video { width:100%; max-height:70vh; object-fit:contain; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,0.35); }
    .analysis-right { flex:1; max-height:70vh; overflow:auto; padding:6px 4px; display:flex; flex-direction:column; gap:10px; }
    #analysisContent h2,#analysisContent h3,#analysisContent h4 { margin:10px 0 6px; color:#f8fafc; }
    #analysisContent p { margin:6px 0; color:#e5e7eb; line-height:1.65; }
    #analysisContent ul { margin:4px 0 8px 18px; }
    #analysisContent li { margin:2px 0; }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-logo">BOE</div>
        <div class="brand-text">
          <div class="name">客厅视频墙控制台</div>
        </div>
      </div>
      <nav class="main-nav actions">
        <button class="nav-btn active" data-nav="dashboard" onclick="switchView('dashboard', this)">
          <svg viewBox="0 0 24 24"><rect x="4" y="4" width="7" height="7" rx="1.5"/><rect x="13" y="4" width="7" height="4" rx="1.2"/><rect x="13" y="10" width="7" height="10" rx="1.2"/><rect x="4" y="13" width="7" height="7" rx="1.5"/></svg>
          <span class="nav-label">首页概览</span>
        </button>
        <button class="nav-btn" data-nav="materials" onclick="switchView('materials', this)">
          <svg viewBox="0 0 24 24"><path d="M3 7h8l2 3h8v9H3Z" stroke-linejoin="round"/><path d="M3 7V5h6l2 2" stroke-linecap="round"/></svg>
          <span class="nav-label">素材管理</span>
        </button>
        <button class="nav-btn" data-nav="upload" onclick="switchView('upload', this)">
          <svg viewBox="0 0 24 24"><rect x="4" y="5" width="16" height="14" rx="2"/><path d="M8 12h8M12 9v6" stroke-linecap="round"/></svg>
          <span class="nav-label">节目与模板</span>
        </button>
        <button class="nav-btn" data-nav="programs" onclick="switchView('programs', this)">
          <svg viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M9 6v12M15 6v12M4 11h16" stroke-linecap="round"/></svg>
          <span class="nav-label">节目库</span>
        </button>
        <button class="nav-btn" data-nav="schedule" onclick="switchView('schedule', this)">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"/><path d="M12 9v4l3 2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="nav-label">排程管理</span>
        </button>
        <button class="nav-btn" data-nav="devices" onclick="switchView('devices', this)">
          <svg viewBox="0 0 24 24"><rect x="4" y="5" width="16" height="11" rx="2"/><path d="M9 19h6" stroke-linecap="round"/><path d="M10.5 16.5h3" stroke-linecap="round"/></svg>
          <span class="nav-label">设备管理</span>
        </button>
        <button class="nav-btn" data-nav="settings" onclick="switchView('settings', this)">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M4 12h2m12 0h2M12 4v2m0 12v2M6 6l1.4 1.4M16.6 16.6 18 18M6 18l1.4-1.4M16.6 7.4 18 6" stroke-linecap="round"/></svg>
          <span class="nav-label">系统管理</span>
        </button>
      </nav>
      <div class="side-footer">
        <div class="mode-switch">
          <button class="mode-btn" id="modeScreen" onclick="setSystemMode('upload')"><span class="nav-label">画屏</span></button>
          <button class="mode-btn" id="modeSplice" onclick="setSystemMode('programs')"><span class="nav-label">拼接</span></button>
        </div>
        <div class="version-text" id="serverVersion">v0.8.0</div>
      </div>
    </aside>

    <button id="sidebarToggle" class="sidebar-toggle" onclick="toggleSidebar()" aria-label="收起侧边栏">
      <span class="toggle-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 5 7 12l7 7"></path>
        </svg>
      </span>
    </button>

    <div class="main-content">
      <div class="topbar">
        <div>
          <div class="topbar-title" id="topTitle">首页概览</div>
        </div>
        <div class="user-chip">
          <span class="dot-online"></span>
          <span>在线</span>
        </div>
      </div>

      <div id="dashboard" class="view dashboard-view">
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-icon"><img src="/img/dashboard-1.png" alt="设备"></div>
            <div>
              <div class="stat-meta">设备数量</div>
              <div class="stat-value" id="statDevicesTotal">0</div>
              <div class="stat-meta" id="statDevicesOnline">在线 0 台</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><img src="/img/dashboard-2.png" alt="节目"></div>
            <div>
              <div class="stat-meta">节目数量</div>
              <div class="stat-value" id="statPrograms">0</div>
              <div class="stat-meta">最近更新 <span id="statProgramsUpdated">-</span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><img src="/img/dashboard-3.png" alt="计划"></div>
            <div>
              <div class="stat-meta">计划数量</div>
              <div class="stat-value" id="statSchedules">0</div>
              <div class="stat-meta" id="statNextSchedule">下一次：-</div>
            </div>
          </div>
        </div>

        <div class="panel-grid">
          <section class="card">
            <div class="panel-title">设备状态</div>
            <div class="ring-wrap">
              <canvas id="deviceRing" width="200" height="200"></canvas>
              <div class="ring-center">
                <div class="big" id="deviceRingTotal">0</div>
                <div class="muted-text">台</div>
              </div>
            </div>
            <ul class="legend">
              <li><span class="swatch" style="background:#3b82f6"></span>在线 <span id="legendOnline" style="margin-left:auto;">0</span></li>
              <li><span class="swatch" style="background:#64748b"></span>离线 <span id="legendOffline" style="margin-left:auto;">0</span></li>
            </ul>
          </section>

          <section class="card">
            <div class="panel-title">素材资源</div>
            <div class="ring-wrap">
              <canvas id="materialRing" width="200" height="200"></canvas>
              <div class="ring-center">
                <div class="big" id="materialRingTotal">0</div>
                <div class="muted-text">总量</div>
              </div>
            </div>
            <ul class="legend">
              <li><span class="swatch" style="background:#f59e0b"></span>图片 <span id="legendPic" style="margin-left:auto;">0</span></li>
              <li><span class="swatch" style="background:#22c55e"></span>视频 <span id="legendVideo" style="margin-left:auto;">0</span></li>
              <li><span class="swatch" style="background:#a855f7"></span>音频/其他 <span id="legendAudio" style="margin-left:auto;">0</span></li>
            </ul>
          </section>

          <section class="card">
            <div class="panel-title">设备分布</div>
            <div class="bar-chart" id="deviceBar"></div>
          </section>
        </div>

        <div class="panel-grid">
          <section class="card">
            <div class="panel-title">计划审核提醒</div>
            <table id="scheduleReminder" style="width:100%; border-collapse:collapse; font-size:14px;">
              <thead>
                <tr><th style="text-align:left;">序号</th><th style="text-align:left;">计划名称</th><th style="text-align:left;">计划状态</th><th style="text-align:left;">开始时间</th><th style="text-align:left;">操作</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>
          <section class="card">
            <div class="panel-title">事件记录</div>
            <div class="event-list" id="eventList"></div>
          </section>
        </div>
      </div>

      <div id="confirmModal" class="modal">
        <div class="panel" style="max-width:360px;">
          <div id="confirmText" style="margin-bottom:12px;">确认？</div>
          <div class="actions" style="justify-content:flex-end;">
            <button class="secondary" onclick="closeConfirm()">取消</button>
            <button onclick="runConfirm()">确定</button>
          </div>
        </div>
      </div>

      
<div id="materials" class="view" style="display:none; flex:1;">
  <section class="card" style="display:flex; flex-direction:column; gap:12px; min-height: calc(100vh - 140px); flex:1;">
    <div style="display:flex; gap:12px; align-items:stretch; flex:1; min-height:0;">
      <div style="width:240px; min-width:240px; display:flex; flex-direction:column; gap:8px; min-height:0;">
        <div class="card" style="background:rgba(255,255,255,0.03); flex:1; display:flex; flex-direction:column; min-height:0;">
          <div style="font-weight:700; margin-bottom:6px;">目录</div>
          <div id="mediaTree" style="flex:1; overflow:auto; display:flex; flex-direction:column; gap:2px;"></div>
        </div>
        <div class="card" style="background:rgba(255,255,255,0.03); flex:0 0 240px; display:flex; flex-direction:column;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div>预览</div>
            <span id="mediaSelLabel" class="badge">未选择</span>
          </div>
          <div id="mediaPreview" style="flex:1; min-height:180px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); border:1px solid var(--card-border); border-radius:8px; overflow:hidden;"></div>
        </div>
      </div>

      <div style="flex:1; display:flex; flex-direction:row; gap:10px; min-height:0;">
        <div class="card" style="background:rgba(255,255,255,0.03); flex:1; min-height:0; display:flex; flex-direction:column;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
            <div id="mediaBreadcrumb" style="color:var(--muted); font-size:12px;">/media</div>
            <div style="display:flex; align-items:center; gap:6px;">
              <button class="secondary" id="btnGenThumbs" onclick="generateThumbsForCurrent()">生成缩略图</button>
              <div id="thumbProgress" style="color:var(--muted); font-size:12px; min-width:140px;"></div>
            </div>
          </div>
          <div id="mediaGrid" style="flex:1; min-height:0; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; align-content:start;"></div>
        </div>
        <div class="card" style="background:rgba(255,255,255,0.03); width:320px; min-width:260px; max-width:360px; padding:10px; display:flex; flex-direction:column; gap:6px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">画作信息</div>
            <span id="metaStatus" style="color:var(--muted); font-size:12px;"></span>
          </div>
          <div id="metaTitle" style="font-size:14px; font-weight:700;"></div>
          <div id="metaArtist" style="color:var(--muted); font-size:13px;"></div>
          <div id="metaFields" style="display:flex; flex-wrap:wrap; gap:8px; color:var(--muted); font-size:12px;"></div>
          <div class="badge" style="background:rgba(255,255,255,0.05);">简介</div>
          <div id="metaIntro" style="color:#e5e7eb; font-size:13px; line-height:1.5; white-space:pre-wrap;"></div>
          <div class="badge" style="background:rgba(255,255,255,0.05);">赏析摘要</div>
          <div id="metaAnalysisPreview" style="color:#cbd5e1; font-size:13px; line-height:1.4; max-height:90px; overflow:hidden;"></div>
          <div class="actions" style="justify-content:flex-start; gap:6px;">
            <button class="secondary" id="btnOpenAnalysis" style="display:none;" onclick="openAnalysisModal(mediaSelected, currentAnalysisInfo)">打开赏析弹窗</button>
          </div>
          <div id="metaExtra" style="color:#94a3b8; font-size:12px;"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="analysisModal" class="modal" style="display:none; background:rgba(0,0,0,0.65);">
  <div class="panel analysis-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div>
        <div id="analysisTitle" style="font-weight:800; font-size:18px; letter-spacing:0.3px;">赏析</div>
        <div id="analysisSubtitle" style="color:var(--muted); font-size:13px;"></div>
      </div>
      <button class="secondary" onclick="closeAnalysisModal()">关闭</button>
    </div>
    <div class="analysis-body">
      <div class="analysis-left" id="analysisMedia"></div>
      <div class="analysis-right">
        <div id="analysisContent"></div>
      </div>
    </div>
  </div>
</div>

<div id="devices" class="view" style="display:none;">
    <section class="card">
      <h3>连接设备</h3>
      <table id="deviceTable2">
        <thead><tr><th>ID</th><th>角色</th><th>IP</th><th>状态</th><th>最近时间</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="actions" style="margin-top:8px;">
        <button onclick="loadDevices(true)">刷新设备</button>
      </div>
    </section>
  </div>

  <!-- 广播页面已移除，保留首页快速广播 -->
  <div id="upload" class="view" style="display:none;">
    <section class="card" style="padding:0; overflow:hidden;">
      <iframe id="builderFrame" src="program-builder.html" style="width:100%; min-height: calc(100vh - 180px); border:0; display:block;"></iframe>
    </section>
  </div>

  <div id="editModal" class="modal">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h4>素材微调 / 裁切</h4>
        <button class="secondary" onclick="closeEditModal()">关闭</button>
      </div>
      <div class="preview-stage" id="editStage"></div>
      <div class="range-row">
        图片停留(秒)：<input type="number" id="editDuration" value="5" min="1" style="width:90px">
        转场效果：
        <select id="editEffect" onchange="renderEditPreview()">
          <option value="random">随机</option>
          <option value="fade">淡入淡出</option>
          <option value="slide">滑动</option>
          <option value="zoom">缩放</option>
          <option value="push">推拉</option>
          <option value="wipe">百叶</option>
        </select>
      </div>
      <div class="range-row">
        裁切偏移 X：<input type="range" id="editOffsetX" min="-400" max="400" step="2" value="0" oninput="renderEditPreview()">
        <span id="editOffsetXVal" style="min-width:50px;">0</span>
        裁切偏移 Y：<input type="range" id="editOffsetY" min="-400" max="400" step="2" value="0" oninput="renderEditPreview()">
        <span id="editOffsetYVal" style="min-width:50px;">0</span>
      </div>
      <div class="actions" style="justify-content:flex-end;">
        <button onclick="applyEdit()">保存</button>
      </div>
    </div>
  </div>

  <div id="programs" class="view" style="display:none;">
    <section class="card">
      <h3>节目列表</h3>
      <div class="row">
        <input id="customTitle" placeholder="节目标题" style="flex:1;min-width:160px">
        <button class="secondary" onclick="saveCustom()">保存当前三屏为节目</button>
        <button class="secondary" onclick="refreshFromDisk()">重新读取节目目录</button>
      </div>
      <table id="programTable">
        <thead><tr><th>ID</th><th>标题</th><th>创建时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <div id="schedule" class="view" style="display:none;">
    <section class="card">
      <h3>排程</h3>
      <div class="row">节目ID：<input id="schedProgramId" placeholder="program id"> 开始UTC毫秒：<input id="schedStart" size="20" placeholder="Date.now()+10000"></div>
      <div class="actions">
        <button onclick="addSchedule()">添加排程</button>
        <button class="secondary" onclick="loadSchedule()">刷新排程</button>
      </div>
      <table id="scheduleTable">
        <thead><tr><th>ID</th><th>节目</th><th>开始</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <div id="power" class="view" style="display:none;">
    <section class="card">
      <h3>电源控制</h3>
      <div class="actions">
        <button onclick="power('sleep')">熄屏/暂停</button>
        <button class="secondary" onclick="power('wake')">唤醒</button>
        <button class="secondary" onclick="power('reboot')">重启</button>
      </div>
    </section>
  </div>

  <div id="settings" class="view" style="display:none;">
    <section class="card">
      <h3>客户端 IP 配置</h3>
      <div class="row">左屏 IP：<input id="ipLeft" size="18" placeholder="192.168.x.x"></div>
      <div class="row">中屏 IP：<input id="ipCenter" size="18" placeholder="192.168.x.x"></div>
      <div class="row">右屏 IP：<input id="ipRight" size="18" placeholder="192.168.x.x"></div>
      <div class="actions">
        <button onclick="saveClientIps()">保存</button>
        <span id="ipSaveStatus" style="color:var(--success);"></span>
      </div>
    </section>
  </div>

  <pre id="log"></pre>
    </div> <!-- main-content -->
  </div> <!-- app-shell -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
<script>
let slides = [];
let timelinePlaying = false;
let timelineIndex = 0;
let timelineTimer = null;
let lastUploadSlices = null;
let stageBoxes = [];
let materials = [];
let materialFolders = [];
let currentFolderId = "root";
let selectedMaterial = null;
let materialSearchName = "";
let materialSearchTag = "";
let programTags = [];
let openFolders = new Set(["root"]);
let hiddenVideoProbe = null;
let programsCache = [];
let devicesCache = [];
let schedulesCache = [];
let statusCache = null;
let sidebarCollapsed = false;
let systemMode = "upload";
let confirmCb = null;
let hlsPlayer = null;
let previewVideo = null;

let mediaCurrentPath = "";
let mediaFolders = [];
let mediaFiles = [];
let mediaTreeData = [];
let mediaTreeOpen = new Set([""]);
let mediaSelected = null;
let metaCache = {};
let sidecarCache = {};
let currentAnalysisInfo = null;
let thumbObserver = null;
let thumbJobTimer = null;
let thumbJobId = null;
let thumbSyncingPath = null;


function startPreview() {
  if (!previewVideo) previewVideo = document.querySelector("#previewVideo");
  const status = document.querySelector("#previewStatus");
  if (!previewVideo) return;
  const src = "/hls/preview.m3u8";
  if (hlsPlayer) {
    hlsPlayer.destroy();
    hlsPlayer = null;
  }
  if (previewVideo.canPlayType("application/vnd.apple.mpegurl")) {
    previewVideo.src = src;
    previewVideo.play().then(()=>{ if(status) status.textContent="播放中"; }).catch(()=>{ if(status) status.textContent="点击开始"; });
  } else if (window.Hls) {
    hlsPlayer = new Hls({ lowLatencyMode: true, maxBufferLength: 4, backBufferLength: 0, fragLoadingTimeOut: 4000 });
    hlsPlayer.loadSource(src);
    hlsPlayer.attachMedia(previewVideo);
    hlsPlayer.on(Hls.Events.MANIFEST_PARSED, ()=>{ previewVideo.play().then(()=>{ if(status) status.textContent="播放中"; }); });
    hlsPlayer.on(Hls.Events.ERROR, (_, data)=>{ if(data.fatal && status) status.textContent="预览错误，重试"; });
  } else {
    if (status) status.textContent = "不支持 HLS";
  }
}

function stopPreview() {
  if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }
  if (!previewVideo) previewVideo = document.querySelector("#previewVideo");
  if (previewVideo) { previewVideo.pause(); previewVideo.removeAttribute("src"); previewVideo.load(); }
  const status = document.querySelector("#previewStatus"); if (status) status.textContent = "已停止";
}

function refreshPreview() {
  stopPreview();
  startPreview();
}

async function sendControl(action) {
  const status = document.querySelector("#controlStatus");
  try {
    const res = await fetch("/api/control", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action })
    });
    const data = await res.json();
    if (data.ok) {
      if (status) status.textContent = `已发送：${action} · ${new Date(data.serverTime || Date.now()).toLocaleTimeString()}`;
    } else {
      if (status) status.textContent = data.error || "发送失败";
    }
  } catch (e) {
    if (status) status.textContent = "网络错误";
  }
}

function resetProgram() {
  slides = [];
  programTags = [];
  document.querySelector("#timelineName").value = `program_${Date.now()}`;
  document.querySelector("#programTagInput").value = "";
  document.querySelector("#programTagChips").innerHTML = "";
  document.querySelector("#totalDuration").textContent = "0s";
  const badge = document.querySelector("#currentProgBadge");
  if (badge) badge.textContent = "当前节目：未命名";
  renderSlidesList();
}

function switchView(id, btn, opts = {}) {
  document.querySelectorAll(".view").forEach(v => {
    if (v.id === id) {
      v.style.display = (id === "materials") ? "flex" : "block";
    } else {
      v.style.display = "none";
    }
  });
  document.querySelectorAll(".main-nav button, nav.actions button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
  if (id === "devices") loadDevices(true);
  if (id === "materials") loadMediaTree(mediaCurrentPath || "");
  if (id === "programs") loadPrograms();
  if (id === "schedule") loadSchedule();
  if (id === "upload") {
    const frame = document.querySelector("#builderFrame");
    if (frame && opts.reload !== false) {
      try { frame.contentWindow.location.reload(); } catch (e) {}
    }
  }
  if (id === "dashboard") startPreview(); else stopPreview();
  const titles = { dashboard:"首页概览", devices:"设备管理", materials:"素材管理", upload:"节目与模板", programs:"节目库", schedule:"排程管理", power:"电源控制", settings:"系统管理" };
  const titleEl = document.querySelector("#topTitle");
  if (titleEl) titleEl.textContent = titles[id] || "控制台";
}

function refreshSidebarToggle() {
  const btn = document.querySelector("#sidebarToggle");
  if (!btn) return;
  const icon = btn.querySelector(".toggle-icon svg");
  if (icon) icon.style.transform = sidebarCollapsed ? "rotate(180deg)" : "rotate(0deg)";
  btn.setAttribute("aria-label", sidebarCollapsed ? "展开侧边栏" : "收起侧边栏");
}

function applySidebarState() {
  document.body.classList.toggle("sidebar-collapsed", sidebarCollapsed);
  localStorage.setItem("sidebarCollapsed", sidebarCollapsed ? "1" : "0");
  refreshSidebarToggle();
}

function toggleSidebar() {
  sidebarCollapsed = !sidebarCollapsed;
  applySidebarState();
}

function renderSystemMode() {
  const scr = document.querySelector("#modeScreen");
  const spi = document.querySelector("#modeSplice");
  if (scr) scr.classList.toggle("active", systemMode === "upload");
  if (spi) spi.classList.toggle("active", systemMode === "programs");
}

function setSystemMode(mode) {
  systemMode = mode === "programs" ? "programs" : "upload";
  localStorage.setItem("systemMode", systemMode);
  renderSystemMode();
  const btn = document.querySelector(`[data-nav="${systemMode}"]`);
  switchView(systemMode, btn, { reload: false });
}

async function safeFetch(url, opts = {}) {
  try {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res;
  } catch (e) {
    log("请求失败: " + e.message);
    return null;
  }
}

// -------- 文件树素材管理（支持同名 JSON / 目录 meta） --------
async function loadMediaTree(path = mediaCurrentPath || "") {
  mediaCurrentPath = path;
  const params = new URLSearchParams();
  if (path) params.set("path", path);
  params.set("full", "1");
  const res = await safeFetch(`/api/media-tree${params.toString() ? `?${params}` : ""}`);
  if (!res) return;
  const data = await res.json();
  mediaFolders = data.folders || [];
  mediaFiles = data.files || [];
  mediaTreeData = data.tree || [];
  const bc = document.querySelector("#mediaBreadcrumb");
  if (bc) bc.textContent = `/media/${data.path || ""}`;
  renderMediaTree(data.path || "");
  renderMediaFiles();
  setMediaPreview(null);
  showMetaForFile(null);
  syncThumbsForCurrent();
}
function renderMediaTree(path="") {
  const tree = document.querySelector("#mediaTree");
  if (!tree) return;
  tree.innerHTML = "";
  const renderNode = (node, depth=0) => {
    if (node.type !== "dir") return;
    const row = document.createElement("div");
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.gap="6px";
    row.style.padding="4px 6px";
    row.style.marginLeft = `${depth*10}px`;
    row.style.borderRadius = "6px";
    row.style.cursor = "pointer";
    row.onmouseenter = ()=> row.style.background = "rgba(255,255,255,0.04)";
    row.onmouseleave = ()=> row.style.background = "transparent";
    const open = mediaTreeOpen.has(node.path || "");
    const caret = document.createElement("span"); caret.textContent = open ? "▼" : "▶"; caret.style.color="var(--muted)";
    const name = document.createElement("span"); name.textContent = node.name || (node.path?node.path.split("/").pop():"media"); name.style.color = node.path===path ? "var(--accent)" : "#fff";
    row.appendChild(caret); row.appendChild(name);
    row.onclick = () => { if (open) mediaTreeOpen.delete(node.path||""); else mediaTreeOpen.add(node.path||""); loadMediaTree(node.path||""); };
    tree.appendChild(row);
    if (open && Array.isArray(node.children)) node.children.forEach(ch=>renderNode(ch, depth+1));
  };
  renderNode({ type:"dir", name:"/media", path:"", children: mediaTreeData }, 0);
}
function renderMediaFiles(){
  const grid = document.querySelector("#mediaGrid");
  if (!grid) return;
  grid.innerHTML = "";
  ensureThumbObserver();
  const items = [];
  mediaFolders.forEach(f=>items.push({ type:"dir", name:f.name, path:f.path, mtime:f.mtime }));
  mediaFiles.forEach(f=>{
    const lower=(f.name||"").toLowerCase();
    const isImage=lower.match(/\.(jpg|jpeg|png|webp|gif|bmp|tif|tiff|heic)$/);
    const isVideo=lower.match(/\.(mp4|mov|mkv|webm|avi)$/);
    if (!(isImage||isVideo)) return;
    items.push({ type:"file", name:f.name, path:f.path, mtime:f.mtime, size:f.size, isMedia:true });
  });
  if (!items.length) { const p=document.createElement("div"); p.style.color="var(--muted)"; p.textContent="该目录下暂无文件"; grid.appendChild(p); return; }
  items.forEach(item=>{
    const card=document.createElement("div"); card.className="media-card";
    if (item.type === "dir") card.onclick=()=>loadMediaTree(item.path); else { card.onclick=()=>selectMediaFile(item); }
    const thumbWrap=document.createElement("div"); thumbWrap.style.width="100%"; thumbWrap.style.height="100px"; thumbWrap.style.borderRadius="6px"; thumbWrap.style.overflow="hidden"; thumbWrap.style.background="rgba(255,255,255,0.04)";
    if (item.type === "dir") {
      thumbWrap.textContent = "📁"; thumbWrap.style.display="flex"; thumbWrap.style.alignItems="center"; thumbWrap.style.justifyContent="center"; thumbWrap.style.fontSize="32px";
    } else {
      const thumb=document.createElement("img"); thumb.className="media-thumb"; thumb.loading="lazy"; thumb.dataset.src = getLocalThumbUrl(item);
      thumb.onerror = ()=>{ thumbWrap.textContent=item.name.split('.').pop(); thumbWrap.style.display='flex'; thumbWrap.style.alignItems='center'; thumbWrap.style.justifyContent='center'; };
      thumbWrap.appendChild(thumb); observeThumb(thumb);
    }
    const title=document.createElement("div"); title.style.fontWeight="700"; title.style.color="var(--accent)"; title.textContent=item.name;
    const meta=document.createElement("div"); meta.style.color="var(--muted)"; meta.style.fontSize="12px"; meta.textContent = item.type==='dir' ? '文件夹' : humanSize(item.size||0);
    card.appendChild(thumbWrap); card.appendChild(title); card.appendChild(meta); grid.appendChild(card);
  });
}
function getLocalThumbUrl(item){ const pathStr=item.path||""; const parts=pathStr.split("/"); const file=parts.pop()||""; const base=file.replace(/\.[^.]+$/,''); const dir=parts.join("/"); const thumbPath= dir ? `${dir}/.thumbs/${base}.jpg` : `.thumbs/${base}.jpg`; return `/ext-media/${encodeURIComponent(thumbPath).replace(/%2F/g,'/')}`; }
function ensureThumbObserver(){ if(!("IntersectionObserver" in window)){ thumbObserver=null; return; } if(thumbObserver) return; thumbObserver = new IntersectionObserver((entries)=>{ entries.forEach(entry=>{ if(!entry.isIntersecting) return; const el=entry.target; const src=el.dataset?.src; if(src){ el.src=src; delete el.dataset.src; } thumbObserver.unobserve(el); }); }, { rootMargin:"200px 0px" }); }
function observeThumb(el){ if(thumbObserver && el?.dataset?.src) thumbObserver.observe(el); else if(el?.dataset?.src){ el.src = el.dataset.src; delete el.dataset.src; } }
async function syncThumbsForCurrent(){ const path=mediaCurrentPath||""; if(thumbSyncingPath===path) return; thumbSyncingPath=path; const res=await safeFetch("/api/media/thumbs/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path})}); thumbSyncingPath=null; if(res){ const data=await res.json(); if(data?.changed) loadMediaTree(path); } loadMetaForCurrent(); }
async function loadMetaForCurrent(force=false){ const path=mediaCurrentPath||""; if(!force && metaCache[path]) return metaCache[path]; const metaPath = path ? `/ext-media/${encodeURIComponent(path + '/.thumbs/meta.json').replace(/%2F/g,'/')}` : "/ext-media/.thumbs/meta.json"; const status=document.querySelector("#metaStatus"); if(status) status.textContent="载入中..."; try { const res=await fetch(metaPath,{cache:"no-store"}); if(!res.ok) throw new Error(res.statusText); const data=await res.json(); let normalized={}; if(data?.["画作列表"] && Array.isArray(data["画作列表"])) { data["画作列表"].forEach(entry=>{ const fname=entry?.meta_data?.["文件名称"]; if(!fname) return; normalized[fname]={ meta: entry.meta_data||{}, intro: entry["简介"]||"", analysis: entry["赏析"]||"" }; }); } metaCache[path]=normalized; if(status) status.textContent="已载入"; return metaCache[path]; } catch(e){ metaCache[path]={}; if(status) status.textContent="无元数据"; return {}; } }
async function loadSidecarForFile(file){ if(!file?.path) return null; const key=file.path; if(Object.prototype.hasOwnProperty.call(sidecarCache, key)) return sidecarCache[key]; const base=file.path.replace(/\.[^.]+$/,''); const url=`/ext-media/${encodeURIComponent(base + '.json').replace(/%2F/g,'/')}`; try { const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error(res.statusText); const data=await res.json(); const meta=data["元信息"]||data.meta_data||data.meta||{}; const intro=data["简介"]||data.intro||""; const analysis=data["赏析"]||data.analysis||""; const norm={ meta,intro,analysis,__source:"sidecar",__file:file.path }; sidecarCache[key]=norm; return norm; } catch(e){ sidecarCache[key]=null; return null; } }
function normalizeAnalysis(raw){ if(!raw) return {title:"", content:""}; if(typeof raw === "string") return { title:"赏析", content: raw }; return { title: raw["标题"]||raw["title"]||raw.title||"赏析", content: raw["内容"]||raw["正文"]||raw.content||"" }; }
function truncateText(str="", max=180){ if(!str) return ""; const clean=str.replace(/\s+/g," ").trim(); return clean.length>max ? clean.slice(0,max) + "..." : clean; }
function escapeHtml(str=""){ return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function markdownToHtml(md=""){ if(!md) return ""; const txt=escapeHtml(md).replace(/\r?\n/g,"\\n"); const lines=txt.split("\\n"); const htmlLines=lines.map(line=>{ if(/^###\\s+/.test(line)) return `<h4>${line.replace(/^###\\s+/,"")}</h4>`; if(/^##\\s+/.test(line)) return `<h3>${line.replace(/^##\\s+/,"")}</h3>`; if(/^#\\s+/.test(line)) return `<h2>${line.replace(/^#\\s+/,"")}</h2>`; if(/^\\s*[-*]\\s+/.test(line)) return `<li>${line.replace(/^\\s*[-*]\\s+/,"")}</li>`; if(!line.trim()) return ""; return `<p>${line}</p>`; }); let html=htmlLines.join(""); html = html.replace(/(?:<li>.*?<\/li>)+/gs, m=>`<ul>${m}</ul>`); return html; }
async function showMetaForFile(file){ const titleEl=document.querySelector("#metaTitle"); const artistEl=document.querySelector("#metaArtist"); const fieldsEl=document.querySelector("#metaFields"); const introEl=document.querySelector("#metaIntro"); const extraEl=document.querySelector("#metaExtra"); const analysisPreviewEl=document.querySelector("#metaAnalysisPreview"); const analysisBtn=document.querySelector("#btnOpenAnalysis"); const statusEl=document.querySelector("#metaStatus"); if(!titleEl) return; if(!file){ titleEl.textContent="未选择"; if(artistEl) artistEl.textContent=""; if(fieldsEl) fieldsEl.innerHTML=""; if(introEl) introEl.textContent=""; if(extraEl) extraEl.textContent=""; if(analysisPreviewEl) analysisPreviewEl.textContent=""; if(analysisBtn) analysisBtn.style.display="none"; currentAnalysisInfo=null; return; } const folderMeta = await loadMetaForCurrent(); let info = folderMeta?.[file.name] || null; let source = info ? "folder" : ""; if(!info){ const sidecar = await loadSidecarForFile(file); if(sidecar){ info=sidecar; source="sidecar"; } } if(!info){ titleEl.textContent=file.name; if(artistEl) artistEl.textContent="暂无元数据"; if(fieldsEl) fieldsEl.innerHTML=""; if(introEl) introEl.textContent=""; if(extraEl) extraEl.textContent=""; if(analysisPreviewEl) analysisPreviewEl.textContent="暂无赏析"; if(analysisBtn) analysisBtn.style.display="none"; if(statusEl) statusEl.textContent="无元数据"; currentAnalysisInfo=null; return; } const md = info.meta || {}; const title = md["作品名称"]||md["文件名称"]||md["画作名"]||file.name; const artist = md["作者"]||""; const year=md["创作时间"]||""; const nation=md["国籍"]||""; titleEl.textContent = title; if(artistEl) artistEl.textContent = [artist,year].filter(Boolean).join(" · ") || nation || ""; if(fieldsEl){ fieldsEl.innerHTML=""; const pairs=[["画派/风格", md["画派"]||md["风格流派"]],["国籍", md["国籍"]],["材质", md["材质"]],["作品类型", md["作品类型"]],["尺寸", md["尺寸"]],["文件格式", md["文件格式"]],["收藏机构", md["收藏机构"]]]; pairs.forEach(([k,v])=>{ if(!v) return; const chip=document.createElement("span"); chip.className="badge"; chip.textContent=`${k}: ${v}`; fieldsEl.appendChild(chip); }); } const introText = info.intro || md["简介"] || ""; if(introEl) introEl.textContent = introText || ""; const analysisData = normalizeAnalysis(info.analysis); if(analysisPreviewEl) analysisPreviewEl.textContent = analysisData.content ? truncateText(analysisData.content, 200) : "暂无赏析"; if(analysisBtn){ if(analysisData.content){ analysisBtn.style.display="inline-flex"; analysisBtn.disabled=false; analysisBtn.onclick=()=>openAnalysisModal(file, info); } else analysisBtn.style.display="none"; } currentAnalysisInfo = info; if(extraEl){ const wiki = md["画作百科"]||md["百科"]||""; extraEl.textContent = wiki; } if(statusEl) statusEl.textContent = source==="sidecar" ? "来自同名 JSON" : "目录元数据"; }
function setMediaPreview(file){ const box=document.querySelector("#mediaPreview"); if(!box) return; box.innerHTML=""; if(!file){ box.textContent="未选择"; box.style.color="var(--muted)"; showMetaForFile(null); return; } const url=`/ext-media/${file.path}`; const ext=(file.name||"").toLowerCase(); if(ext.match(/\\.mp4|\\.mov|\\.mkv|\\.webm|\\.avi/)){ const v=document.createElement("video"); v.src=url; v.controls=true; v.muted=true; v.loop=true; v.style.width="100%"; v.style.maxHeight="260px"; v.style.objectFit="contain"; box.appendChild(v);} else if(ext.match(/\\.jpg|\\.jpeg|\\.png|\\.webp|\\.gif|\\.bmp|\\.tif|\\.tiff|\\.heic/)){ const img=document.createElement("img"); img.src=url; img.style.maxWidth="100%"; img.style.maxHeight="260px"; img.style.objectFit="contain"; box.appendChild(img);} else { const a=document.createElement("a"); a.href=url; a.textContent="下载/打开"; a.style.color="var(--accent)"; a.target="_blank"; box.appendChild(a);} }
function selectMediaFile(file){ mediaSelected=file; const label=document.querySelector("#mediaSelLabel"); if(label) label.textContent=file?.name||"未选择"; setMediaPreview(file); showMetaForFile(file); }
function openAnalysisModal(file=mediaSelected, info=currentAnalysisInfo){ if(!file) return; const modal=document.querySelector("#analysisModal"); const mediaBox=document.querySelector("#analysisMedia"); const contentEl=document.querySelector("#analysisContent"); const titleEl=document.querySelector("#analysisTitle"); const subEl=document.querySelector("#analysisSubtitle"); if(!modal||!mediaBox||!contentEl||!titleEl) return; const data=info||{}; const analysis=normalizeAnalysis(data.analysis); const md=data.meta||{}; titleEl.textContent = analysis.title || md["作品名称"] || md["画作名"] || file.name; if(subEl){ const subtitle=[md["作者"], md["创作时间"], md["画派"]||md["风格流派"]].filter(Boolean).join(" · "); subEl.textContent = subtitle; } mediaBox.innerHTML=""; const url=`/ext-media/${encodeURIComponent(file.path).replace(/%2F/g,'/')}`; const lower=(file.name||"").toLowerCase(); if(lower.match(/\\.mp4|\\.mov|\\.mkv|\\.webm|\\.avi/)){ const v=document.createElement("video"); v.src=url; v.controls=true; v.autoplay=true; v.loop=true; v.muted=true; v.style.width="100%"; v.style.maxHeight="70vh"; v.style.objectFit="contain"; mediaBox.appendChild(v);} else { const img=document.createElement("img"); img.src=url; img.alt=file.name||"analysis"; img.style.width="100%"; img.style.maxHeight="70vh"; img.style.objectFit="contain"; mediaBox.appendChild(img);} contentEl.innerHTML = analysis.content ? markdownToHtml(analysis.content) : "<p style=\\\"color:var(--muted);\\\">暂无赏析</p>"; modal.style.display="flex"; }
function closeAnalysisModal(){ const modal=document.querySelector("#analysisModal"); if(modal) modal.style.display="none"; }

function humanSize(bytes = 0) {
  if (!bytes) return "0B";
  const units = ["B","KB","MB","GB"];
  let u = 0, n = bytes;
  while (n >= 1024 && u < units.length -1) { n /= 1024; u++; }
  return n.toFixed(n >= 10 ? 0 : 1) + units[u];
}

function humanTime(ts) {
  return ts ? new Date(ts).toLocaleString() : "";
}

function setText(id, txt) {
  const el = document.getElementById(id);
  if (el) el.textContent = txt;
}

function drawRing(canvasOrId, segments = [], colors = []) {
  const canvas = typeof canvasOrId === "string" ? document.getElementById(canvasOrId) : canvasOrId;
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const total = segments.reduce((a, b) => a + (b || 0), 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const r = Math.min(cx, cy) - 12;
  let start = -Math.PI / 2;
  if (total <= 0) {
    ctx.beginPath();
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.lineWidth = 18;
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.stroke();
    return;
  }
  segments.forEach((val, idx) => {
    if (!val) return;
    const ang = (val / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.strokeStyle = colors[idx] || "#3b82f6";
    ctx.lineWidth = 18;
    ctx.lineCap = "round";
    ctx.arc(cx, cy, r, start, start + ang);
    ctx.stroke();
    start += ang;
  });
}

function renderSummary() {
  const totalDevices = statusCache?.devices?.total ?? devicesCache.length;
  const onlineDevices = statusCache?.devices?.online ?? devicesCache.filter(d => d.online).length;
  setText("statDevicesTotal", totalDevices || 0);
  setText("statDevicesOnline", `在线 ${onlineDevices || 0} 台`);
  setText("deviceRingTotal", totalDevices || 0);

  const programCount = statusCache?.programs ?? programsCache.length;
  setText("statPrograms", programCount || 0);
  const latestProgram = programsCache?.reduce((a, b) => (a?.createdAt || 0) > (b?.createdAt || 0) ? a : b, null);
  setText("statProgramsUpdated", latestProgram?.createdAt ? humanTime(latestProgram.createdAt) : "无");

  const schedCount = statusCache?.schedules ?? schedulesCache.length;
  setText("statSchedules", schedCount || 0);
  const upcoming = schedulesCache.filter(s => (s.startAtUtcMs || 0) > Date.now()).sort((a,b)=>a.startAtUtcMs - b.startAtUtcMs)[0];
  setText("statNextSchedule", upcoming ? `下一次：${humanTime(upcoming.startAtUtcMs)}` : "下一次：-");
}

function renderDeviceRing() {
  const online = devicesCache.filter(d => d.online).length;
  const total = statusCache?.devices?.total ?? devicesCache.length;
  const offline = Math.max(0, total - online);
  setText("legendOnline", online);
  setText("legendOffline", offline);
  setText("deviceRingTotal", total || 0);
  drawRing("deviceRing", [online, offline], ["#3b82f6", "#64748b"]);
}

function renderMaterialRing() {
  const agg = { pic:0, video:0, audio:0 };
  (materials || []).forEach(m => {
    const mime = (m.mime || "").toLowerCase();
    const size = Number(m.size || 0);
    if (mime.startsWith("image")) agg.pic += size;
    else if (mime.startsWith("video")) agg.video += size;
    else if (mime.startsWith("audio")) agg.audio += size;
    else agg.audio += size;
  });
  const total = agg.pic + agg.video + agg.audio;
  setText("materialRingTotal", total ? humanSize(total) : "0");
  setText("legendPic", humanSize(agg.pic));
  setText("legendVideo", humanSize(agg.video));
  setText("legendAudio", humanSize(agg.audio));
  drawRing("materialRing", [agg.pic, agg.video, agg.audio], ["#f59e0b", "#22c55e", "#a855f7"]);
}

function renderDeviceBars() {
  const wrap = document.querySelector("#deviceBar");
  if (!wrap) return;
  wrap.innerHTML = "";
  if (!devicesCache.length) {
    wrap.innerHTML = `<div class="muted-text">暂无设备</div>`;
    return;
  }
  const groups = {};
  devicesCache.forEach(d => {
    const role = d.role || "未分组";
    groups[role] = (groups[role] || 0) + 1;
  });
  const max = Math.max(...Object.values(groups), 1);
  Object.entries(groups).forEach(([role, count]) => {
    const row = document.createElement("div");
    row.className = "bar-row";
    const fill = Math.round((count / max) * 100);
    row.innerHTML = `<span style="width:60px;">${role}</span>
      <div class="bar"><div class="fill" style="width:${fill}%;"></div></div>
      <span style="width:34px;text-align:right;">${count}</span>`;
    wrap.appendChild(row);
  });
}

function renderScheduleReminder() {
  const tbody = document.querySelector("#scheduleReminder tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  if (!schedulesCache.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="muted-text">暂无排程</td>`;
    tbody.appendChild(tr);
    return;
  }
  const sorted = [...schedulesCache].sort((a, b) => (a.startAtUtcMs || 0) - (b.startAtUtcMs || 0));
  sorted.slice(0, 6).forEach((s, idx) => {
    const status = (s.startAtUtcMs || 0) > Date.now() ? "待播放" : "已触发/过期";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${idx + 1}</td>
      <td>${s.programId || s.id}</td>
      <td>${status}</td>
      <td>${humanTime(s.startAtUtcMs)}</td>
      <td><button class="secondary" onclick="deleteSchedule('${s.id}')">删除</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderEventList() {
  const wrap = document.querySelector("#eventList");
  if (!wrap) return;
  const items = [];
  devicesCache.forEach(d => items.push({ time: d.lastSeen || Date.now(), text: `设备 ${d.id || d.role || ""} ${d.online ? "在线" : "离线"}` }));
  schedulesCache.forEach(s => items.push({ time: s.startAtUtcMs || 0, text: `排程 ${s.programId || s.id} 将播放` }));
  if (!items.length) {
    wrap.innerHTML = `<div class="muted-text">暂无事件</div>`;
    return;
  }
  items.sort((a, b) => b.time - a.time);
  wrap.innerHTML = "";
  items.slice(0, 8).forEach(evt => {
    const div = document.createElement("div");
    div.className = "event-item";
    div.innerHTML = `<div>${evt.text}</div><div class="time">${evt.time ? humanTime(evt.time) : ""}</div>`;
    wrap.appendChild(div);
  });
}

function updateDashboard() {
  renderSummary();
  renderDeviceRing();
  renderMaterialRing();
  renderDeviceBars();
  renderScheduleReminder();
  renderEventList();
}

async function loadMaterials(folderId = currentFolderId) {
  currentFolderId = folderId || "root";
  const res = await safeFetch(`/api/materials${currentFolderId ? `?folderId=${currentFolderId}` : ""}`);
  if (!res) return;
  const data = await res.json();
  materials = data.materials || [];
  materialFolders = data.folders || [];
  renderMaterials();
  renderFolders();
  renderMaterialsUpload();
  syncFolderSelects();
  if (selectedMaterial) {
    const found = materials.find(m=>m.id===selectedMaterial.id);
    if (found) { selectedMaterial = found; renderTags(); }
    else { selectedMaterial = null; document.querySelector("#materialPreview").innerHTML=""; document.querySelector("#materialName").textContent="未选择"; renderTags(); }
  }
  updateDashboard();
}

function renderMaterials() {
  const tbody = document.querySelector("#materialTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  renderTagFilters();
  const filtered = materials.filter((m) => {
    const byName = materialSearchName ? (m.name || "").toLowerCase().includes(materialSearchName.toLowerCase()) : true;
    const byTag = materialSearchTag
      ? (m.tags || []).some((t) => t.toLowerCase().includes(materialSearchTag.toLowerCase()))
      : true;
    return byName && byTag;
  });
  filtered.forEach((m) => {
    const tr = document.createElement("tr");
    tr.dataset.id = m.id;
    tr.innerHTML = `<td style="cursor:pointer;color:var(--accent);">${m.name}</td>
      <td>${(m.tags||[]).map(t=>`<span class="badge">${t}</span>`).join(" ")}</td>
      <td>${humanSize(m.size)}</td>
      <td>${m.mime || ""}</td>
      <td>${humanTime(m.uploadedAt)}</td>`;
    const tdOps = document.createElement("td");
    const btnRename = document.createElement("button");
    btnRename.className = "secondary";
    btnRename.textContent = "重命名";
    btnRename.onclick = (e) => { e.stopPropagation(); renameMaterial(m.id); };
    const btnDel = document.createElement("button");
    btnDel.className = "secondary";
    btnDel.style.marginLeft = "6px";
    btnDel.textContent = "删除";
    btnDel.onclick = (e) => { e.stopPropagation(); deleteMaterial(m.id); };
    tdOps.appendChild(btnRename); tdOps.appendChild(btnDel);
    tr.appendChild(tdOps);
    tr.onclick = () => selectMaterial(m.id);
    tbody.appendChild(tr);
  });
  if (!materials.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="color:var(--muted);">暂无素材，先上传。</td>`;
    tbody.appendChild(tr);
    return;
  }
  if (!filtered.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="color:var(--muted);">未找到匹配结果，试试更宽泛的搜索。</td>`;
    tbody.appendChild(tr);
  }
}

function renderTagFilters() {
  const tags = Array.from(
    new Set(
      materials.flatMap((m) => m.tags || [])
    )
  ).sort((a,b)=>a.localeCompare(b,"zh"));
  [["#searchTagSelect", true], ["#searchTagSelectUpload", true]].forEach(([selector,_use])=>{
    const sel = document.querySelector(selector);
    if (sel) {
      const current = materialSearchTag;
      sel.innerHTML = `<option value="">全部标签</option>` + tags.map(t=>`<option value="${t}">${t}</option>`).join("");
      sel.value = current || "";
    }
  });
  const dl = document.querySelector("#tagOptions");
  if (dl) dl.innerHTML = tags.map(t=>`<option value="${t}">`).join("");
}

async function uploadMaterial() {
  const f = document.querySelector("#materialFile");
  if (!f?.files?.length) { alert("请选择文件"); return; }
  const form = new FormData();
  form.append("file", f.files[0]);
  form.append("folderId", currentFolderId || "root");
  document.querySelector("#materialStatus").textContent = "上传中...";
  const res = await safeFetch("/api/materials", { method: "POST", body: form });
  if (!res) { document.querySelector("#materialStatus").textContent = "上传失败"; return; }
  const data = await res.json();
  if (data.ok) {
    document.querySelector("#materialStatus").textContent = "上传成功";
    f.value = "";
    loadMaterials();
  } else {
    document.querySelector("#materialStatus").textContent = data.error || "失败";
  }
  setTimeout(()=>document.querySelector("#materialStatus").textContent="",1800);
}

async function renameMaterial(id) {
  const m = materials.find(x=>x.id===id);
  if (!m) return;
  const name = prompt("请输入新名字", m.name);
  if (!name) return;
  const res = await safeFetch(`/api/materials/${id}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ name }) });
  if (res) loadMaterials(currentFolderId);
}

async function deleteMaterial(id) {
  showConfirm("确定删除该素材？", async () => {
    const res = await safeFetch(`/api/materials/${id}`, { method:"DELETE" });
    if (res) {
      if (selectedMaterial?.id === id) { selectedMaterial = null; document.querySelector("#materialPreview").innerHTML=""; document.querySelector("#materialName").textContent="未选择"; }
      loadMaterials(currentFolderId);
    }
  });
}

function selectMaterial(id) {
  const m = materials.find(x=>x.id===id);
  if (!m) return;
  selectedMaterial = m;
  document.querySelector("#materialName").textContent = m.name;
  const selectedLabel = document.querySelector("#selectedMaterialName");
  if (selectedLabel) selectedLabel.textContent = m.name;
  const moveSel = document.querySelector("#moveFolderSelect");
  if (moveSel) moveSel.value = m.folderId || "root";
  renderTags();
  const box = document.querySelector("#materialPreview");
  box.innerHTML = "";
  if ((m.mime || "").startsWith("image")) {
    const img = document.createElement("img");
    img.src = m.url;
    img.style.maxWidth = "100%";
    img.style.maxHeight = "240px";
    img.style.borderRadius = "10px";
    box.appendChild(img);
  } else if ((m.mime || "").startsWith("video")) {
    const v = document.createElement("video");
    v.src = m.url;
    v.controls = true;
    v.style.maxWidth = "100%";
    v.style.maxHeight = "240px";
    box.appendChild(v);
  } else {
    const a = document.createElement("a");
    a.href = m.url;
    a.textContent = "下载/查看";
    a.style.color = "var(--accent)";
    box.appendChild(a);
  }
  // 高亮列表行
  document.querySelectorAll("#materialTable tbody tr").forEach(tr=>{
    if (tr.dataset.id === m.id) tr.classList.add("row-selected");
    else tr.classList.remove("row-selected");
  });
  highlightUploadMaterial(m.id);
  renderSelectedPreview(m);
}

function renderFolders() {
  const wrap = document.querySelector("#folderList");
  if (!wrap) return;
  wrap.innerHTML = "";
  materialFolders.forEach((f) => {
    const div = document.createElement("div");
    div.textContent = f.name;
    div.style.padding = "6px 8px";
    div.style.border = "1px solid var(--card-border)";
    div.style.borderRadius = "8px";
    div.style.cursor = "pointer";
    div.style.background = f.id === currentFolderId ? "rgba(56,189,248,0.18)" : "rgba(255,255,255,0.03)";
    div.onclick = () => loadMaterials(f.id);
    wrap.appendChild(div);
  });
}

function renderMaterialsUpload() {
  const tree = document.querySelector("#uploadFolderTree");
  const listWrap = document.querySelector("#uploadMaterialList");
  if (!tree || !listWrap) return;
  tree.innerHTML = "";
  listWrap.innerHTML = "";
  materialFolders.forEach((f) => {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "6px";
    item.style.padding = "6px 8px";
    item.style.border = "1px solid var(--card-border)";
    item.style.borderRadius = "8px";
    item.style.cursor = "pointer";
    const open = openFolders.has(f.id);
    item.style.background = f.id === currentFolderId ? "rgba(56,189,248,0.18)" : "rgba(255,255,255,0.04)";
    item.innerHTML = `<span>${open ? "▾" : "▸"}</span><span>${f.name}</span>`;
    item.onclick = () => { 
      if (open) openFolders.delete(f.id); else openFolders.add(f.id);
      currentFolderId = f.id;
      renderMaterialsUpload();
    };
    tree.appendChild(item);
    if (open) {
      const ul = document.createElement("div");
      ul.style.marginLeft = "14px";
      const filtered = materials.filter((m)=>m.folderId===f.id);
      filtered.forEach((m)=>{
        const row = document.createElement("div");
        row.dataset.id = m.id;
        row.style.display="flex";
        row.style.alignItems="center";
        row.style.justifyContent="space-between";
        row.style.padding="6px 8px";
        row.style.border="1px solid var(--card-border)";
        row.style.borderRadius="8px";
        row.style.marginTop="4px";
        row.style.cursor="pointer";
        row.className = selectedMaterial?.id===m.id ? "row-selected" : "";
        row.onclick = ()=>selectMaterial(m.id);
        row.innerHTML = `<span style="color:var(--accent);">${m.name}</span><span style="color:var(--muted);font-size:12px;">${m.mime||""}</span>`;
        ul.appendChild(row);
      });
      if (!filtered.length) {
        const row = document.createElement("div");
        row.style.padding="4px 8px";
        row.style.color="var(--muted)";
        row.textContent = "该文件夹暂无素材";
        ul.appendChild(row);
      }
      tree.appendChild(ul);
    }
  });

  // 平铺列表（当前折叠状态下的可见素材）
  const visibleMats = materials.filter((m)=>openFolders.has(m.folderId));
  const filtered = visibleMats.filter((m)=>{
    const byName = materialSearchName ? m.name.toLowerCase().includes(materialSearchName.toLowerCase()) : true;
    const byTag = materialSearchTag ? (m.tags||[]).some(t=>t.toLowerCase().includes(materialSearchTag.toLowerCase())) : true;
    return byName && byTag;
  });
  filtered.forEach((m)=>{
    const row=document.createElement("div");
    row.dataset.id = m.id;
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.justifyContent="space-between";
    row.style.padding="6px 8px";
    row.style.marginBottom="6px";
    row.style.border="1px solid var(--card-border)";
    row.style.borderRadius="8px";
    row.style.cursor="pointer";
    row.className = selectedMaterial?.id===m.id ? "row-selected" : "";
    row.onclick = ()=>selectMaterial(m.id);
    row.innerHTML = `<div><div style="color:var(--accent);">${m.name}</div><div style="color:var(--muted);font-size:12px;">${(m.tags||[]).join(", ")}</div></div><div style="color:var(--muted);font-size:12px;">${humanSize(m.size)}</div>`;
    listWrap.appendChild(row);
  });
  if (!filtered.length) {
    const tip=document.createElement("div");
    tip.style.color="var(--muted)";
    tip.textContent="没有可见素材，换个文件夹或清空筛选。";
    listWrap.appendChild(tip);
  }
  // 同步搜索下拉标签
  renderTagFilters();
  if (selectedMaterial) highlightUploadMaterial(selectedMaterial.id);
}

function highlightUploadMaterial(id) {
  document.querySelectorAll("#uploadMaterialList [data-id]").forEach(div=>{
    if (div.dataset.id === id) div.classList.add("row-selected"); else div.classList.remove("row-selected");
  });
}

function renderSelectedPreview(m) {
  const box = document.querySelector("#selectedPreview");
  if (!box) return;
  box.innerHTML = "";
  if ((m.mime||"").startsWith("image")) {
    const img=document.createElement("img");
    img.src = m.url;
    img.style.maxWidth="100%"; img.style.maxHeight="160px"; img.style.borderRadius="10px";
    box.appendChild(img);
  } else if ((m.mime||"").startsWith("video")) {
    const v=document.createElement("video");
    v.src=m.url; v.controls=true; v.style.maxWidth="100%"; v.style.maxHeight="160px"; v.muted=true;
    v.onloadeddata = ()=>{ 
      try { v.currentTime = Math.min(1, v.duration/2 || 0); } catch(_) {}
    };
    const poster = document.createElement("div");
    poster.style.width="100%"; poster.style.height="160px";
    poster.style.background="radial-gradient(circle at 30% 30%, rgba(56,189,248,0.25), rgba(0,0,0,0.6))";
    poster.style.display="flex"; poster.style.alignItems="center"; poster.style.justifyContent="center";
    poster.style.borderRadius="10px"; poster.style.color="#9ca3af"; poster.textContent="加载视频预览中...";
    v.oncanplay = ()=>{ if (poster.parentNode) poster.parentNode.replaceChild(v, poster); };
    box.appendChild(poster);
  } else {
    const a=document.createElement("a"); a.href=m.url; a.textContent="下载/查看"; a.style.color="var(--accent)";
    box.appendChild(a);
  }
}
function syncFolderSelects() {
  const selects = [document.querySelector("#uploadFolderSelect"), document.querySelector("#moveFolderSelect")];
  selects.forEach((sel) => {
    if (!sel) return;
    sel.innerHTML = "";
    materialFolders.forEach((f) => {
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      if (f.id === currentFolderId) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}

async function newFolder() {
  const name = prompt("文件夹名称");
  if (!name) return;
  const res = await safeFetch("/api/materials/folders", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ name }) });
  if (res) loadMaterials(currentFolderId);
  else document.querySelector("#materialStatus").textContent = "新建失败，检查服务是否重启";
}

async function renameFolder() {
  if (!currentFolderId || currentFolderId === "root") { alert("请选择可重命名的文件夹"); return; }
  const folder = materialFolders.find(f=>f.id===currentFolderId);
  const name = prompt("新名称", folder?.name || "");
  if (!name) return;
  const res = await safeFetch(`/api/materials/folders/${currentFolderId}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ name }) });
  if (res) loadMaterials(currentFolderId);
}

async function deleteFolder() {
  if (!currentFolderId || currentFolderId === "root") { alert("不能删除根文件夹"); return; }
  showConfirm("删除后文件将移动到根目录，确认？", async () => {
    const res = await safeFetch(`/api/materials/folders/${currentFolderId}`, { method:"DELETE" });
    if (res) { currentFolderId = "root"; loadMaterials("root"); }
  });
}

async function moveMaterial() {
  if (!selectedMaterial) { alert("先选择素材"); return; }
  const folderId = document.querySelector("#moveFolderSelect").value || "root";
  const res = await safeFetch(`/api/materials/${selectedMaterial.id}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ folderId }) });
  if (res) loadMaterials(folderId);
}

function renderTags() {
  const wrap = document.querySelector("#tagChips");
  const wrapSel = document.querySelector("#programTagChips");
  if (!wrap) return;
  wrap.innerHTML = "";
  (selectedMaterial?.tags || []).forEach((t) => {
    const chip = document.createElement("span");
    chip.className = "badge";
    chip.textContent = t + " ✕";
    chip.style.cursor = "pointer";
    chip.onclick = () => removeTag(t);
    wrap.appendChild(chip);
  });
  if (wrapSel) {
    wrapSel.innerHTML = "";
    programTags.forEach((t) => {
      const chip = document.createElement("span");
      chip.className = "badge";
      chip.textContent = t + " ✕";
      chip.style.cursor = "pointer";
      chip.onclick = () => removeProgramTag(t);
      wrapSel.appendChild(chip);
    });
  }
}

async function addTag() {
  if (!selectedMaterial) { alert("先选择素材"); return; }
  const input = document.querySelector("#tagInput");
  const val = (input.value || "").trim();
  if (!val) return;
  const tags = Array.from(new Set([...(selectedMaterial.tags || []), val]));
  const res = await safeFetch(`/api/materials/${selectedMaterial.id}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ tags }) });
  if (res) { input.value=""; loadMaterials(currentFolderId); }
}

async function removeTag(tag) {
  if (!selectedMaterial) return;
  const tags = (selectedMaterial.tags || []).filter((t) => t !== tag);
  const res = await safeFetch(`/api/materials/${selectedMaterial.id}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ tags }) });
  if (res) loadMaterials(currentFolderId);
}

function addProgramTag() {
  const input = document.querySelector("#programTagInput");
  const val = (input.value || "").trim();
  if (!val) return;
  programTags = Array.from(new Set([...programTags, val]));
  input.value = "";
  renderTags();
}
function removeProgramTag(tag) {
  programTags = programTags.filter((t)=>t!==tag);
  renderTags();
}

function renderDevices(selector, list = []) {
  const tbody = document.querySelector(selector);
  if (!tbody) return;
  tbody.innerHTML = "";
  list.forEach((d) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.id}</td><td>${d.role}</td><td>${d.ip || ""}</td><td>${d.online ? "在线" : "离线"}</td><td>${new Date(d.lastSeen || 0).toLocaleTimeString()}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadStatus() {
  const res = await safeFetch("/api/status");
  if (!res) return;
  statusCache = await res.json();
  if (statusCache?.version) setText("serverVersion", `v${statusCache.version}`);
  updateDashboard();
}

async function loadDevices(refreshOnly = false) {
  const res = await safeFetch("/api/devices");
  if (!res) return;
  const data = await res.json();
  devicesCache = data.devices || [];
  renderDevices("#deviceTable tbody", data.devices);
  renderDevices("#deviceTable2 tbody", data.devices);
  updateDashboard();
}

async function sendPlay(useAlt = false) {
  const delay = Number(document.querySelector(useAlt ? "#delay2" : "#delay").value || 0);
  const body = {
    programId: document.querySelector(useAlt ? "#programId2" : "#programId").value || "manual",
    startAtUtcMs: Date.now() + delay * 1000,
    loop: true,
    screens: {
      left: { url: document.querySelector(useAlt ? "#urlLeft2" : "#urlLeft").value, effect: "fade", audio: false },
      center: { url: document.querySelector(useAlt ? "#urlCenter2" : "#urlCenter").value, effect: "fade", audio: true },
      right: { url: document.querySelector(useAlt ? "#urlRight2" : "#urlRight").value, effect: "fade", audio: false },
    },
  };
  const res = await safeFetch("/api/broadcast", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  log(JSON.stringify(data, null, 2));
}

async function sendStop() {
  const res = await safeFetch("/api/stop", { method: "POST" });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function power(action) {
  const res = await safeFetch("/api/power", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function doUpload() {
  const fileInput = document.querySelector("#uploadFile");
  if (!fileInput.files.length) { alert("请选择文件"); return; }
  const form = new FormData();
  form.append("file", fileInput.files[0]);
  form.append("mode", document.querySelector("#mode").value);
  form.append("gap1", document.querySelector("#gap1").value || "0");
  form.append("gap2", document.querySelector("#gap2").value || "0");
  document.querySelector("#uploadStatus").textContent = "上传中...";
  document.querySelector("#previewArea").style.display = "none";
  const res = await safeFetch("/api/upload", { method: "POST", body: form });
  if (!res) return;
  const data = await res.json();
  if (data.ok) {
    const p = data.program;
    document.querySelector("#uploadStatus").textContent = `生成节目 ${p.id}`;
    document.querySelector("#previewArea").style.display = "block";
    document.querySelector("#prevLeft").src = p.slices.left.preview;
    document.querySelector("#prevCenter").src = p.slices.center.preview;
    document.querySelector("#prevRight").src = p.slices.right.preview;
    window.__lastProgramId = p.id;
    loadPrograms();
    lastUploadSlices = { left: p.slices.left.url, center: p.slices.center.url, right: p.slices.right.url, preview: p.slices.center.preview };
    document.querySelector("#currentProgBadge").textContent = `当前节目：${p.id}`;
    addSlideFromUpload();
  } else {
    document.querySelector("#uploadStatus").textContent = `失败: ${data.error}`;
  }
}

async function confirmBroadcast() {
  const pid = window.__lastProgramId;
  if (!pid) { alert("没有可发布的节目"); return; }
  const res = await safeFetch(`/api/programs/${pid}/broadcast`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ startAtUtcMs: Date.now() + 5000 }) });
  if (!res) return;
  const data = await res.json();
  log(JSON.stringify(data, null, 2));
}

async function loadPrograms() {
  const res = await safeFetch("/api/programs");
  if (!res) return;
  const data = await res.json();
  programsCache = data.programs || [];
  const tbody = document.querySelector("#programTable tbody");
  tbody.innerHTML = "";
  (data.programs || []).forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.id}</td><td>${p.title || ""}</td><td>${new Date(p.createdAt).toLocaleString()}</td>
    <td><button onclick=\"broadcastProgram('${p.id}')\">播放</button> <button class=\"secondary\" onclick=\"loadSequence('${p.id}')\">载入制作</button></td>`;
    tbody.appendChild(tr);
  });
  updateDashboard();
}

async function broadcastProgram(id) {
  const res = await safeFetch(`/api/programs/${id}/broadcast`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ startAtUtcMs: Date.now() + 5000 }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
}

async function loadProgramsForEditor() {
  const res = await safeFetch("/api/programs");
  if (!res) return;
  const data = await res.json();
  programsCache = data.programs || [];
  const wrap = document.querySelector("#programListEditor");
  if (!wrap) return;
  wrap.innerHTML = "";
  programsCache.forEach((p)=>{
    const row = document.createElement("div");
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.justifyContent="space-between";
    row.style.padding="6px 8px";
    row.style.border="1px solid var(--card-border)";
    row.style.borderRadius="8px";
    row.style.marginBottom="6px";
    row.style.cursor="pointer";
    row.onclick = ()=>loadSequence(p.id);
    row.innerHTML = `<div><div style="color:var(--accent);">${p.title||p.id}</div><div style="color:var(--muted);font-size:12px;">${p.id}</div></div>`;
    const ops = document.createElement("div");
    const btnRen = document.createElement("button"); btnRen.className="secondary"; btnRen.textContent="重命名"; btnRen.onclick=(e)=>{ e.stopPropagation(); renameProgram(p.id); };
    const btnDel = document.createElement("button"); btnDel.className="secondary"; btnDel.style.marginLeft="6px"; btnDel.textContent="删除"; btnDel.onclick=(e)=>{ e.stopPropagation(); deleteProgram(p.id); };
    ops.appendChild(btnRen); ops.appendChild(btnDel);
    row.appendChild(ops);
    wrap.appendChild(row);
  });
  if (!programsCache.length) {
    const tip=document.createElement("div"); tip.style.color="var(--muted)"; tip.textContent="暂无节目，先保存一个吧。";
    wrap.appendChild(tip);
  }
}

async function renameProgram(id) {
  const p = programsCache.find(x=>x.id===id);
  const name = prompt("新节目名称", p?.title || id);
  if (!name) return;
  const res = await safeFetch(`/api/programs/${id}`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ title: name }) });
  if (res) { loadPrograms(); loadProgramsForEditor(); }
}

async function deleteProgram(id) {
  showConfirm("确定删除该节目？", async () => {
    const res = await safeFetch(`/api/programs/${id}`, { method:"DELETE" });
    if (res) { 
      loadPrograms(); 
      loadProgramsForEditor(); 
      if (document.querySelector("#currentProgBadge")?.textContent.includes(id)) resetProgram();
    }
  });
}

function showConfirm(msg, cb) {
  confirmCb = cb;
  document.querySelector("#confirmText").textContent = msg;
  document.querySelector("#confirmModal").style.display = "flex";
}
function closeConfirm() {
  confirmCb = null;
  document.querySelector("#confirmModal").style.display = "none";
}
function runConfirm() {
  const cb = confirmCb;
  closeConfirm();
  if (typeof cb === "function") cb();
}

function loadSequence(id) {
  // 节目制作已迁移到独立页面
  window.location.href = `program-builder.html?programId=${encodeURIComponent(id)}`;
}

async function saveCustom() {
  const title = document.querySelector("#customTitle").value || "custom";
  const id = title.toLowerCase().replace(/[^a-z0-9]+/g, "_") + "_" + Date.now();
  const slices = { left: { url: document.querySelector("#urlLeft").value, effect: "random", audio: false }, center: { url: document.querySelector("#urlCenter").value, effect: "random", audio: true }, right: { url: document.querySelector("#urlRight").value, effect: "random", audio: false } };
  const res = await safeFetch("/api/programs/custom", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, title, slices }) });
  if (!res) return;
  const data = await res.json();
  if (data.ok) { loadPrograms(); log(`已保存节目 ${id}`); } else { log(`保存失败: ${data.error}`); }
}

async function refreshFromDisk() {
  const res = await safeFetch("/api/programs/reload", { method: "POST" });
  if (!res) return;
  const data = await res.json();
  if (data.ok) { loadPrograms(); log(`已从磁盘刷新，当前节目数 ${data.count}`); } else { log(`刷新失败: ${data.error}`); }
}

async function addSchedule() {
  const programId = document.querySelector("#schedProgramId").value;
  const startAtUtcMs = Number(document.querySelector("#schedStart").value);
  const res = await safeFetch("/api/schedule", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ programId, startAtUtcMs }) });
  if (!res) return;
  log(JSON.stringify(await res.json(), null, 2));
  loadSchedule();
}

async function loadSchedule() {
  const res = await safeFetch("/api/schedule");
  if (!res) return;
  const data = await res.json();
  schedulesCache = data.schedules || [];
  const tbody = document.querySelector("#scheduleTable tbody");
  tbody.innerHTML = "";
  (data.schedules || []).forEach((s) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.id}</td><td>${s.programId}</td><td>${new Date(s.startAtUtcMs).toLocaleString()}</td>
    <td><button onclick=\"deleteSchedule('${s.id}')\">删除</button></td>`;
    tbody.appendChild(tr);
  });
  updateDashboard();
}

async function deleteSchedule(id) {
  const res = await safeFetch(`/api/schedule/${id}`, { method: "DELETE" });
  if (!res) return;
  loadSchedule();
}

function log(msg) { document.querySelector("#log").textContent = msg; }

async function loadClientIps() {
  const res = await safeFetch("/api/client-ips");
  if (!res) return;
  const data = await res.json();
  const ips = data.clientIps || {};
  document.querySelector("#ipLeft").value = ips.left || "";
  document.querySelector("#ipCenter").value = ips.center || "";
  document.querySelector("#ipRight").value = ips.right || "";
}

async function saveClientIps() {
  const body = { left: document.querySelector("#ipLeft").value, center: document.querySelector("#ipCenter").value, right: document.querySelector("#ipRight").value };
  const res = await safeFetch("/api/client-ips", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  document.querySelector("#ipSaveStatus").textContent = data.ok ? "已保存" : (data.error || "失败");
  setTimeout(() => (document.querySelector("#ipSaveStatus").textContent = ""), 2000);
}

function updateGapPreview() {
  const gap1El = document.querySelector("#gap1");
  const gap2El = document.querySelector("#gap2");
  if (!gap1El || !gap2El) return; // 旧节目制作视图已隐藏/移除时避免报错
  const gap1 = Number(gap1El.value || 0);
  const gap2 = Number(gap2El.value || 0);
  const total = 1080 + gap1 + 3840 + gap2 + 1080;
  const scale = 600 / total;
  const segs = [
    { w: 1080, color: "#38bdf8", label: "左屏" },
    { w: gap1, color: "#f59e0b", label: `缝1 ${gap1}px` },
    { w: 3840, color: "#22c55e", label: "中屏" },
    { w: gap2, color: "#f59e0b", label: `缝2 ${gap2}px` },
    { w: 1080, color: "#38bdf8", label: "右屏" },
  ];
  const viz = document.querySelector("#gapViz");
  if (viz) {
    viz.innerHTML = "";
    segs.forEach((s) => {
      const div = document.createElement("div");
      div.style.width = `${Math.max(s.w * scale, 2)}px`;
      div.style.height = "40px";
      div.style.background = s.color;
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.justifyContent = "center";
      div.style.fontSize = "11px";
      div.style.color = "#0b1021";
      div.textContent = s.label;
      viz.appendChild(div);
    });
  }
  const gapLabel = document.querySelector("#gapLabel");
  if (gapLabel) gapLabel.textContent = `总宽 ${total}px，缩放预览 600px；缝隙将被“压缩”掉，避免实际拼缝黑边。`;
  buildPreviewStage(gap1, gap2);
  buildEditStage();
}

function newProgram() {
  slides = [];
  lastUploadSlices = null;
  document.querySelector("#timelineName").value = `program_${Date.now()}`;
  document.querySelector("#currentProgBadge").textContent = "当前节目：未命名";
  renderSlidesList();
}

function renderSlidesList() {
  const wrap = document.querySelector("#slidesList");
  if (!wrap) return;
  wrap.innerHTML = "";
  slides.forEach((s, idx) => {
    const row = document.createElement("div");
    row.className = "slide-row";
    row.draggable = true;
    row.ondragstart = (e)=>{ e.dataTransfer.setData("text/plain", idx); };
    row.ondragover = (e)=>{ e.preventDefault(); row.style.borderColor= "var(--accent)"; };
    row.ondragleave = ()=>{ row.style.borderColor="var(--card-border)"; };
    row.ondrop = (e)=>{ e.preventDefault(); row.style.borderColor="var(--card-border)"; const from=Number(e.dataTransfer.getData("text/plain")); const to=idx; reorderSlide(from,to); };
    const thumb = document.createElement("img");
    thumb.src = s.preview || s.urlCenter || s.url || (s.type==="video" ? "/public/video-placeholder.png" : "");
    thumb.className = "thumb";
    row.appendChild(thumb);
    const info = document.createElement("div");
    info.style.flex = "1";
    const dur = getSlideDuration(s);
    info.innerHTML = `<div>#${idx + 1} ${s.type.toUpperCase()} ${s.title || ""}</div>
      <div style=\"font-size:12px;color:var(--muted);\">时长: ${dur}s · 来源: ${s.sourceName||""}</div>`;
    row.appendChild(info);
    const ctrls = document.createElement("div");
    ctrls.style.display="flex"; ctrls.style.gap="6px"; ctrls.style.alignItems="center";
    const durInput = document.createElement("input");
    durInput.type="number"; durInput.min="1"; durInput.style.width="70px"; durInput.value = s.duration || (s.type==="image"? Number(document.querySelector("#defaultImageDur").value||5):dur);
    durInput.onchange = ()=>{ s.duration = Number(durInput.value)||dur; updateTotalDuration(); renderSlidesList(); };
    ctrls.appendChild(durInput);
    ["↑","↓","删"].forEach((txt,i)=>{
      const b=document.createElement("button"); b.textContent=txt;
      b.onclick=()=>{ if(i===0) moveSlide(idx,-1); else if(i===1) moveSlide(idx,1); else deleteSlide(idx); };
      ctrls.appendChild(b);
    });
    row.appendChild(ctrls);
    wrap.appendChild(row);
  });
  if (!slides.length) {
    const tip = document.createElement("div");
    tip.style.color = "var(--muted)";
    tip.textContent = "暂无素材，右侧选择素材后点“加入节目”。";
    wrap.appendChild(tip);
  }
  updateTotalDuration();
}

function moveSlide(idx, delta) {
  const n = idx + delta;
  if (n < 0 || n >= slides.length) return;
  [slides[idx], slides[n]] = [slides[n], slides[idx]];
  renderSlidesList();
}
function reorderSlide(from, to) {
  if (from === to || from<0 || to<0 || from>=slides.length || to>=slides.length) return;
  const s = slides.splice(from,1)[0];
  slides.splice(to,0,s);
  renderSlidesList();
}
function deleteSlide(idx) { slides.splice(idx,1); renderSlidesList(); }
function editSlide(idx) { openEditModal(idx); }
function applyDefaults() {
  const dur = Number(document.querySelector("#defaultImageDur").value || 5);
  slides = slides.map(s => {
    if (s.type === "image") s.duration = dur;
    return s;
  });
  renderSlidesList();
}
function addSlideFromUpload() {
  if (!lastUploadSlices) { alert("先上传素材"); return; }
  const type = lastUploadSlices.center.toLowerCase().match(/\.mp4|\.mov|\.webm/) ? "video" : "image";
  slides.push({ type, title: document.querySelector("#timelineName").value || "upload", urlLeft: lastUploadSlices.left, urlCenter: lastUploadSlices.center, urlRight: lastUploadSlices.right, preview: lastUploadSlices.preview || lastUploadSlices.center, effect: "random", duration: 5, offsetX:0, offsetY:0 });
  renderSlidesList();
}

let currentEditIndex = -1;

function addSelectedToTimeline() {
  if (!selectedMaterial) { alert("先在右侧选择素材"); return; }
  const isVideo = (selectedMaterial.mime || "").startsWith("video");
  const slide = {
    id: "s_" + Date.now(),
    type: isVideo ? "video" : "image",
    title: selectedMaterial.name,
    sourceId: selectedMaterial.id,
    sourceName: selectedMaterial.name,
    urlLeft: selectedMaterial.url,
    urlCenter: selectedMaterial.url,
    urlRight: selectedMaterial.url,
    preview: selectedMaterial.url,
    duration: isVideo ? 0 : Number(document.querySelector("#defaultImageDur").value || 5),
  };
  slides.push(slide);
  renderSlidesList();
  if (isVideo) probeVideoDuration(slide, selectedMaterial.url);
}

function probeVideoDuration(slide, url) {
  if (!hiddenVideoProbe) {
    hiddenVideoProbe = document.createElement("video");
    hiddenVideoProbe.style.position = "fixed";
    hiddenVideoProbe.style.left = "-9999px";
    document.body.appendChild(hiddenVideoProbe);
  }
  hiddenVideoProbe.onloadedmetadata = () => {
    const dur = Math.max(1, Math.round(hiddenVideoProbe.duration));
    slide.duration = dur;
    updateTotalDuration();
    renderSlidesList();
  };
  hiddenVideoProbe.onerror = () => {
    slide.duration = slide.duration || 5;
    updateTotalDuration();
  };
  hiddenVideoProbe.src = url;
}

function openEditModal(idx) {
  currentEditIndex = idx;
  const s = slides[idx];
  document.querySelector("#editDuration").value = s.duration || 5;
  document.querySelector("#editEffect").value = s.effect || "random";
  document.querySelector("#editOffsetX").value = s.offsetX || 0;
  document.querySelector("#editOffsetY").value = s.offsetY || 0;
  document.querySelector("#editOffsetXVal").textContent = `${s.offsetX || 0}px`;
  document.querySelector("#editOffsetYVal").textContent = `${s.offsetY || 0}px`;
  buildEditStage();
  renderEditPreview();
  document.querySelector("#editModal").style.display = "flex";
}

function closeEditModal() {
  document.querySelector("#editModal").style.display = "none";
  currentEditIndex = -1;
}

function applyEdit() {
  if (currentEditIndex < 0) return;
  const s = slides[currentEditIndex];
  s.duration = Number(document.querySelector("#editDuration").value || s.duration || 5);
  s.effect = document.querySelector("#editEffect").value || "random";
  s.offsetX = Number(document.querySelector("#editOffsetX").value || 0);
  s.offsetY = Number(document.querySelector("#editOffsetY").value || 0);
  slides[currentEditIndex] = s;
  renderSlidesList();
  closeEditModal();
}

function renderEditPreview() {
  if (currentEditIndex < 0) return;
  const s = slides[currentEditIndex];
  const ox = Number(document.querySelector("#editOffsetX").value || 0);
  const oy = Number(document.querySelector("#editOffsetY").value || 0);
  document.querySelector("#editOffsetXVal").textContent = `${ox}px`;
  document.querySelector("#editOffsetYVal").textContent = `${oy}px`;
  const eff = document.querySelector("#editEffect").value || s.effect || "random";
  setStageMedia(document.querySelector("#editStageLeft"), document.querySelector("#editStageLeftImg"), s.urlLeft, eff, { x: ox, y: oy });
  setStageMedia(document.querySelector("#editStageCenter"), document.querySelector("#editStageCenterImg"), s.urlCenter, eff, { x: ox, y: oy });
  setStageMedia(document.querySelector("#editStageRight"), document.querySelector("#editStageRightImg"), s.urlRight, eff, { x: ox, y: oy });
}

function buildPreviewStage(gap1=0, gap2=0) {
  const container = document.querySelector("#stageContainer");
  if (!container) return;
  container.innerHTML = "";
  const total = 1080 + gap1 + 3840 + gap2 + 1080;
  const scale = 680 / total;
  const parts = [
    { w:1080, h:1920, id:"stageLeft" },
    { w:gap1, gap:true },
    { w:1920, h:1080, id:"stageCenter" },
    { w:gap2, gap:true },
    { w:1080, h:1920, id:"stageRight" },
  ];
  stageBoxes = [];
  parts.forEach(p=>{
    const div=document.createElement("div");
    div.style.width=`${Math.max(4, p.w*scale)}px`;
    div.style.height=`${Math.max(80, (p.h || 1080)*scale)}px`;
    if (p.gap) { div.style.background="rgba(255,255,255,0.08)"; container.appendChild(div); return; }
    div.className="stage-box";
    const v=document.createElement("video"); v.id=p.id; v.muted=true; v.dataset.scale = scale;
    const img=document.createElement("img"); img.id=p.id+"Img"; img.style.display="none"; img.dataset.scale = scale;
    div.appendChild(v); div.appendChild(img);
    container.appendChild(div);
    stageBoxes.push({ box:div, video:v, img });
  });
}

function buildEditStage() {
  const wrap = document.querySelector("#editStage");
  if (!wrap) return;
  wrap.innerHTML = "";
  const gap1 = Number(document.querySelector("#gap1").value || 0);
  const gap2 = Number(document.querySelector("#gap2").value || 0);
  const total = 1080 + gap1 + 3840 + gap2 + 1080;
  const scale = 520 / total;
  const parts = [
    { w:1080, h:1920, id:"editStageLeft" },
    { w:gap1, gap:true },
    { w:1920, h:1080, id:"editStageCenter" },
    { w:gap2, gap:true },
    { w:1080, h:1920, id:"editStageRight" },
  ];
  parts.forEach(p=>{
    const div=document.createElement("div");
    div.style.width=`${Math.max(4, p.w*scale)}px`;
    div.style.height=`${Math.max(80, (p.h||1080)*scale)}px`;
    if (p.gap) { div.style.background="rgba(255,255,255,0.08)"; wrap.appendChild(div); return; }
    div.className="stage-box";
    const v=document.createElement("video"); v.id=p.id; v.muted=true; v.dataset.scale = scale;
    const img=document.createElement("img"); img.id=p.id+"Img"; img.style.display="none"; img.dataset.scale = scale;
    div.appendChild(v); div.appendChild(img);
    wrap.appendChild(div);
  });
}

function setStageMedia(videoEl, imgEl, url, effect="fade", offset={x:0,y:0}) {
  if (!url) { videoEl.style.display="none"; imgEl.style.display="none"; return; }
  const isVid = url.toLowerCase().match(/\.mp4|\.mov|\.webm/);
  const cls = effectClass(effect);
  videoEl.className = cls; imgEl.className = cls;
  const fitMode = (document.querySelector("#mode")?.value || "cover");
  const fit = fitMode === "stretch" ? "fill" : fitMode;
  videoEl.style.objectFit = fit; imgEl.style.objectFit = fit;
  const scale = Number(videoEl.dataset.scale || videoEl.parentElement?.dataset?.scale || 1);
  const shiftX = -(offset.x || 0) * scale;
  const shiftY = -(offset.y || 0) * scale;
  videoEl.style.transform = `translate(${shiftX}px, ${shiftY}px)`;
  imgEl.style.transform = `translate(${shiftX}px, ${shiftY}px)`;
  if (isVid) { videoEl.src = url; videoEl.style.display="block"; imgEl.style.display="none"; videoEl.currentTime=0; videoEl.play(); }
  else { imgEl.src = url; imgEl.style.display="block"; videoEl.style.display="none"; videoEl.pause(); }
}
function effectClass(effect){ 
  if (effect === "random") {
    const list = ["anim-fade","anim-slide","anim-zoom","anim-push","anim-wipe"];
    return list[Math.floor(Math.random()*list.length)];
  }
  if (effect==="slide") return "anim-slide"; 
  if (effect==="zoom") return "anim-zoom"; 
  if (effect==="fade") return "anim-fade"; 
  if (effect==="push") return "anim-push";
  if (effect==="wipe") return "anim-wipe";
  return "";
}

function playSlide(idx) {
  clearTimeout(timelineTimer);
  const s = slides[idx];
  document.querySelector("#previewLabel").textContent = `第 ${idx+1}/${slides.length} · ${s.title||""} · 转场 ${s.effect||"random"}`;
  setStageMedia(document.querySelector("#stageLeft"), document.querySelector("#stageLeftImg"), s.urlLeft, s.effect, { x: s.offsetX||0, y: s.offsetY||0 });
  setStageMedia(document.querySelector("#stageCenter"), document.querySelector("#stageCenterImg"), s.urlCenter, s.effect, { x: s.offsetX||0, y: s.offsetY||0 });
  setStageMedia(document.querySelector("#stageRight"), document.querySelector("#stageRightImg"), s.urlRight, s.effect, { x: s.offsetX||0, y: s.offsetY||0 });
  if (!timelinePlaying) return;
  const durMs = getSlideDuration(s) * 1000;
  timelineTimer = setTimeout(()=>{ timelineIndex = (timelineIndex+1)%slides.length; playSlide(timelineIndex); }, durMs);
}
function previewTimeline() { if (!slides.length) { alert("先添加素材"); return; } timelinePlaying = true; timelineIndex = 0; document.querySelector("#timelinePreviewPanel").style.display="block"; document.querySelector("#btnPlay").textContent="暂停"; playSlide(timelineIndex); }
function stopTimelinePreview() { timelinePlaying=false; clearTimeout(timelineTimer); document.querySelector("#timelinePreviewPanel").style.display="none"; }
function togglePlay(){ timelinePlaying=!timelinePlaying; document.querySelector("#btnPlay").textContent= timelinePlaying? "暂停":"播放"; if(timelinePlaying) playSlide(timelineIndex);} 
function prevSlide(){ if(!slides.length)return; timelineIndex=(timelineIndex-1+slides.length)%slides.length; playSlide(timelineIndex);} 
function nextSlide(){ if(!slides.length)return; timelineIndex=(timelineIndex+1)%slides.length; playSlide(timelineIndex);} 
function fastForward(){ if(!slides.length)return; timelineIndex=(timelineIndex+2)%slides.length; playSlide(timelineIndex);} 
function getSlideDuration(s) {
  if (s.duration && s.duration > 0) return s.duration;
  if (s.type === "image") return Number(document.querySelector("#defaultImageDur").value || 5);
  return 5;
}
function updateTotalDuration() {
  const total = slides.reduce((acc,s)=>acc + getSlideDuration(s), 0);
  const label = document.querySelector("#totalDuration");
  if (label) label.textContent = `${total}s`;
}

async function saveTimeline() {
  if (!slides.length) { alert("先添加素材"); return; }
  const name = document.querySelector("#timelineName").value || `program_${Date.now()}`;
  const first = slides[0];
  const sequence = slides.map((s)=>({ ...s, duration: getSlideDuration(s) }));
  const slices = { left: { url: first.urlLeft, effect: first.effect || "fade", audio: false }, center: { url: first.urlCenter, effect: first.effect || "fade", audio: true }, right: { url: first.urlRight, effect: first.effect || "fade", audio: false } };
  const body = { id: name, title: name, tags: programTags, totalDurationSec: sequence.reduce((a,s)=>a+getSlideDuration(s),0), slices, sequence };
  const res = await safeFetch("/api/programs/custom", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
  if (!res) return;
  const data = await res.json();
  document.querySelector("#timelineStatus").textContent = data.ok ? "已保存节目" : (data.error || "失败");
  loadPrograms();
  setTimeout(()=>document.querySelector("#timelineStatus").textContent="",2000);
}

// 初始加载
sidebarCollapsed = localStorage.getItem("sidebarCollapsed") === "1";
applySidebarState();
systemMode = localStorage.getItem("systemMode") || "upload";
renderSystemMode();
loadStatus();
loadDevices();
loadMaterials();
loadMediaTree("");
loadPrograms();
loadSchedule();
loadClientIps();
updateGapPreview();
startPreview();
</script>
</body>
</html>



