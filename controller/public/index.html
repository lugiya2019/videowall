<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>VideoWall 控制台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    input, button { padding: 6px; margin: 4px 0; }
    .row { margin-bottom: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #f5f5f5; }
    .section { border: 1px solid #eee; padding: 12px; margin-bottom: 16px; }
    .section h3 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>视频墙控制台</h1>

  <section class="section">
    <h3>在线设备</h3>
    <button onclick="loadDevices()">刷新列表</button>
    <table id="deviceTable">
      <thead><tr><th>ID</th><th>角色</th><th>状态</th><th>最近时间</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section">
    <h3>手动下发</h3>
    <div class="row">左 URL：<input id="urlLeft" size="60" placeholder="http://example/left.mp4"></div>
    <div class="row">中 URL：<input id="urlCenter" size="60" placeholder="http://example/center.mp4"></div>
    <div class="row">右 URL：<input id="urlRight" size="60" placeholder="http://example/right.mp4"></div>
    <div class="row">延时(秒)：<input id="delay" type="number" value="5" min="0" style="width:80px"> 节目ID：<input id="programId" value="manual"></div>
    <button onclick="sendPlay()">下发并同步播放</button>
    <button onclick="sendStop()">停止</button>
  </section>

  <section class="section">
    <h3>素材上传（6000x1920 自动裁切三屏）</h3>
    <input type="file" id="uploadFile">
    <button onclick="doUpload()">上传并生成节目</button>
    <div id="uploadStatus"></div>
  </section>

  <section class="section">
    <h3>节目列表</h3>
    <button onclick="loadPrograms()">刷新节目</button>
    <table id="programTable">
      <thead><tr><th>ID</th><th>名称</th><th>创建时间</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section">
    <h3>排期</h3>
    <div class="row">节目ID：<input id="schedProgramId" placeholder="program id"> 开始UTC毫秒：<input id="schedStart" size="20" placeholder="Date.now()+10000"></div>
    <button onclick="addSchedule()">添加排期</button>
    <button onclick="loadSchedule()">刷新排期</button>
    <table id="scheduleTable">
      <thead><tr><th>ID</th><th>节目</th><th>开始</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="section">
    <h3>电源控制</h3>
    <button onclick="power('sleep')">息屏/暂停</button>
    <button onclick="power('wake')">唤醒</button>
    <button onclick="power('reboot')">重启</button>
  </section>

  <pre id="log"></pre>

<script>
async function loadDevices() {
  const res = await fetch('/api/devices');
  const data = await res.json();
  const tbody = document.querySelector('#deviceTable tbody');
  tbody.innerHTML = '';
  data.devices.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.id}</td><td>${d.role}</td><td>${d.online?'在线':'离线'}</td><td>${new Date(d.lastSeen||0).toLocaleTimeString()}</td>`;
    tbody.appendChild(tr);
  });
}

async function sendPlay() {
  const delay = Number(document.querySelector('#delay').value || 0);
  const body = {
    programId: document.querySelector('#programId').value || 'manual',
    startAtUtcMs: Date.now() + delay * 1000,
    loop: true,
    screens: {
      left:   { url: document.querySelector('#urlLeft').value, effect: 'fade', audio: false },
      center: { url: document.querySelector('#urlCenter').value, effect: 'fade', audio: true },
      right:  { url: document.querySelector('#urlRight').value, effect: 'fade', audio: false }
    }
  };
  const res = await fetch('/api/broadcast', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const data = await res.json();
  log(JSON.stringify(data,null,2));
}

async function sendStop() {
  const res = await fetch('/api/stop', { method:'POST' });
  log(JSON.stringify(await res.json(), null, 2));
}

async function power(action){
  const res = await fetch('/api/power', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action})});
  log(JSON.stringify(await res.json(), null, 2));
}

async function doUpload(){
  const fileInput = document.querySelector('#uploadFile');
  if (!fileInput.files.length) { alert('请选择文件'); return; }
  const form = new FormData();
  form.append('file', fileInput.files[0]);
  document.querySelector('#uploadStatus').textContent = '上传中...';
  const res = await fetch('/api/upload', { method:'POST', body: form });
  const data = await res.json();
  document.querySelector('#uploadStatus').textContent = data.ok ? `生成节目 ${data.program.id}` : `失败: ${data.error}`;
  loadPrograms();
}

async function loadPrograms(){
  const res = await fetch('/api/programs');
  const data = await res.json();
  const tbody = document.querySelector('#programTable tbody');
  tbody.innerHTML = '';
  (data.programs||[]).forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.title||''}</td><td>${new Date(p.createdAt).toLocaleString()}</td>
    <td><button onclick="broadcastProgram('${p.id}')">下发</button></td>`;
    tbody.appendChild(tr);
  });
}

async function broadcastProgram(id){
  const res = await fetch(`/api/programs/${id}/broadcast`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ startAtUtcMs: Date.now()+5000 })});
  log(JSON.stringify(await res.json(), null, 2));
}

async function addSchedule(){
  const programId = document.querySelector('#schedProgramId').value;
  const startAtUtcMs = Number(document.querySelector('#schedStart').value);
  const res = await fetch('/api/schedule', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ programId, startAtUtcMs })});
  log(JSON.stringify(await res.json(), null, 2));
  loadSchedule();
}

async function loadSchedule(){
  const res = await fetch('/api/schedule');
  const data = await res.json();
  const tbody = document.querySelector('#scheduleTable tbody');
  tbody.innerHTML = '';
  (data.schedules||[]).forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.id}</td><td>${s.programId}</td><td>${new Date(s.startAtUtcMs).toLocaleString()}</td>
    <td><button onclick="deleteSchedule('${s.id}')">删除</button></td>`;
    tbody.appendChild(tr);
  });
}

async function deleteSchedule(id){
  await fetch(`/api/schedule/${id}`, { method:'DELETE' });
  loadSchedule();
}

function log(msg){
  document.querySelector('#log').textContent = msg;
}

loadDevices();
loadPrograms();
loadSchedule();
</script>
</body>
</html>
